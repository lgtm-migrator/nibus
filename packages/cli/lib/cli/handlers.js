"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeAddressHandler = void 0;

require("source-map-support/register");

var _mib = require("@nibus/core/lib/mib");

var _core = _interopRequireWildcard(require("@nibus/core"));

var _nibus = require("@nibus/core/lib/nibus");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

const makeAddressHandler = (action, breakout = false) => args => new Promise(async (resolve, reject) => {
  let hasFound = false;

  const close = err => {
    clearTimeout(timeout);

    _core.default.close();

    if (err || !hasFound) {
      return reject(err || 'Устройство не найдено');
    }

    resolve();
  };

  const mac = new _core.Address(args.mac);
  let count = await _core.default.start();

  if (args.timeout && args.timeout !== (0, _nibus.getNibusTimeout)() * 1000) {
    (0, _nibus.setNibusTimeout)(args.timeout * 1000);
  } // На Windows сложнее метод определения и занимает больше времени


  if (process.platform === 'win32') {
    count *= 3;
  } // const setCount: NibusCounter = (handler = (c: number) => c) => count = handler(count);


  const perform = async (connection, mibOrType, version) => {
    clearTimeout(timeout);

    const device = _mib.devices.create(mac, mibOrType, version);

    device.connection = connection;
    await action(device, args);
    hasFound = true;
  };

  _core.default.on('found', async ({
    address,
    connection
  }) => {
    try {
      if (address.equals(mac) && connection.description.mib) {
        if (!args.mib || args.mib === connection.description.mib) {
          await perform(connection, connection.description.mib);
          if (breakout) return close();
          wait();
        }
      }

      if (address.equals(mac) && connection.description.type || connection.description.link) {
        count += 1;
        const [version, type] = await connection.getVersion(mac);

        if (type) {
          await perform(connection, type, version);
          if (breakout) return close();
          wait();
        }
      }
    } catch (e) {
      close(e.message || e);
    }

    count -= 1;

    if (count === 0) {
      clearTimeout(timeout);
      process.nextTick(close);
    }
  });

  const wait = () => {
    count -= 1;

    if (count > 0) {
      timeout = setTimeout(wait, (0, _nibus.getNibusTimeout)());
    } else {
      close();
    }
  };

  let timeout = setTimeout(wait, (0, _nibus.getNibusTimeout)());
});

exports.makeAddressHandler = makeAddressHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvaGFuZGxlcnMudHMiXSwibmFtZXMiOlsibWFrZUFkZHJlc3NIYW5kbGVyIiwiYWN0aW9uIiwiYnJlYWtvdXQiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJoYXNGb3VuZCIsImNsb3NlIiwiZXJyIiwiY2xlYXJUaW1lb3V0IiwidGltZW91dCIsInNlc3Npb24iLCJtYWMiLCJBZGRyZXNzIiwiY291bnQiLCJzdGFydCIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsInBlcmZvcm0iLCJjb25uZWN0aW9uIiwibWliT3JUeXBlIiwidmVyc2lvbiIsImRldmljZSIsImRldmljZXMiLCJjcmVhdGUiLCJvbiIsImFkZHJlc3MiLCJlcXVhbHMiLCJkZXNjcmlwdGlvbiIsIm1pYiIsIndhaXQiLCJ0eXBlIiwibGluayIsImdldFZlcnNpb24iLCJlIiwibWVzc2FnZSIsIm5leHRUaWNrIiwic2V0VGltZW91dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBV0E7O0FBQ0E7O0FBQ0E7Ozs7QUFTQSxNQUFNQSxrQkFBa0IsR0FBRyxDQUMxQkMsTUFEMEIsRUFDSEMsUUFBUSxHQUFHLEtBRFIsS0FFeEJDLElBQUQsSUFDRSxJQUFJQyxPQUFKLENBQVksT0FBT0MsT0FBUCxFQUFnQkMsTUFBaEIsS0FBMkI7QUFDckMsTUFBSUMsUUFBUSxHQUFHLEtBQWY7O0FBQ0EsUUFBTUMsS0FBSyxHQUFJQyxHQUFELElBQWtCO0FBQzlCQyxJQUFBQSxZQUFZLENBQUNDLE9BQUQsQ0FBWjs7QUFDQUMsa0JBQVFKLEtBQVI7O0FBQ0EsUUFBSUMsR0FBRyxJQUFJLENBQUNGLFFBQVosRUFBc0I7QUFDcEIsYUFBT0QsTUFBTSxDQUFDRyxHQUFHLElBQUksdUJBQVIsQ0FBYjtBQUNEOztBQUNESixJQUFBQSxPQUFPO0FBQ1IsR0FQRDs7QUFRQSxRQUFNUSxHQUFHLEdBQUcsSUFBSUMsYUFBSixDQUFZWCxJQUFJLENBQUNVLEdBQWpCLENBQVo7QUFDQSxN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TUFBSUcsT0FBTyxHQUFHMkIsVUFBVSxDQUFDUCxJQUFELEVBQU8sNkJBQVAsQ0FBeEI7QUFDRCxDQW5FRCxDQUhKIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCB7IEFyZ3VtZW50cywgRGVmaW5lZCB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCB7IGRldmljZXMsIElEZXZpY2UgfSBmcm9tICdAbmlidXMvY29yZS9saWIvbWliJztcbmltcG9ydCBzZXNzaW9uLCB7IEFkZHJlc3MgfSBmcm9tICdAbmlidXMvY29yZSc7XG5pbXBvcnQgeyBnZXROaWJ1c1RpbWVvdXQsIE5pYnVzQ29ubmVjdGlvbiwgc2V0TmlidXNUaW1lb3V0IH0gZnJvbSAnQG5pYnVzL2NvcmUvbGliL25pYnVzJztcbmltcG9ydCB7IENvbW1vbk9wdHMgfSBmcm9tICcuL29wdGlvbnMnO1xuXG4vLyBleHBvcnQgdHlwZSBOaWJ1c0NvdW50ZXIgPSAoaGFuZGxlcjogKGNvdW50OiBudW1iZXIpID0+IG51bWJlcikgPT4gdm9pZDtcblxuaW50ZXJmYWNlIEFjdGlvbkZ1bmM8Tz4ge1xuICAoZGV2aWNlOiBJRGV2aWNlLCBhcmdzOiBBcmd1bWVudHM8Tz4pOiBQcm9taXNlPGFueT47XG59XG5cbmNvbnN0IG1ha2VBZGRyZXNzSGFuZGxlciA9IDxPIGV4dGVuZHMgRGVmaW5lZDxDb21tb25PcHRzLCAnbScgfCAnbWFjJz4+XG4oYWN0aW9uOiBBY3Rpb25GdW5jPE8+LCBicmVha291dCA9IGZhbHNlKSA9PlxuICAoYXJnczogQXJndW1lbnRzPE8+KSA9PlxuICAgIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBoYXNGb3VuZCA9IGZhbHNlO1xuICAgICAgY29uc3QgY2xvc2UgPSAoZXJyPzogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgc2Vzc2lvbi5jbG9zZSgpO1xuICAgICAgICBpZiAoZXJyIHx8ICFoYXNGb3VuZCkge1xuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyIHx8ICfQo9GB0YLRgNC+0LnRgdGC0LLQviDQvdC1INC90LDQudC00LXQvdC+Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcbiAgICAgIGNvbnN0IG1hYyA9IG5ldyBBZGRyZXNzKGFyZ3MubWFjKTtcbiAgICAgIGxldCBjb3VudCA9IGF3YWl0IHNlc3Npb24uc3RhcnQoKTtcbiAgICAgIGlmIChhcmdzLnRpbWVvdXQgJiYgYXJncy50aW1lb3V0ICE9PSBnZXROaWJ1c1RpbWVvdXQoKSAqIDEwMDApIHtcbiAgICAgICAgc2V0TmlidXNUaW1lb3V0KGFyZ3MudGltZW91dCAqIDEwMDApO1xuICAgICAgfVxuICAgICAgLy8g0J3QsCBXaW5kb3dzINGB0LvQvtC20L3QtdC1INC80LXRgtC+0LQg0L7Qv9GA0LXQtNC10LvQtdC90LjRjyDQuCDQt9Cw0L3QuNC80LDQtdGCINCx0L7Qu9GM0YjQtSDQstGA0LXQvNC10L3QuFxuICAgICAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHtcbiAgICAgICAgY291bnQgKj0gMztcbiAgICAgIH1cbiAgICAgIC8vIGNvbnN0IHNldENvdW50OiBOaWJ1c0NvdW50ZXIgPSAoaGFuZGxlciA9IChjOiBudW1iZXIpID0+IGMpID0+IGNvdW50ID0gaGFuZGxlcihjb3VudCk7XG5cbiAgICAgIGNvbnN0IHBlcmZvcm0gPSBhc3luYyAoY29ubmVjdGlvbjogTmlidXNDb25uZWN0aW9uLCBtaWJPclR5cGU6IGFueSwgdmVyc2lvbj86IG51bWJlcikgPT4ge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIGNvbnN0IGRldmljZSA9IGRldmljZXMuY3JlYXRlKG1hYywgbWliT3JUeXBlLCB2ZXJzaW9uKTtcbiAgICAgICAgZGV2aWNlLmNvbm5lY3Rpb24gPSBjb25uZWN0aW9uO1xuICAgICAgICBhd2FpdCBhY3Rpb24oZGV2aWNlLCBhcmdzKTtcbiAgICAgICAgaGFzRm91bmQgPSB0cnVlO1xuICAgICAgfTtcblxuICAgICAgc2Vzc2lvbi5vbignZm91bmQnLCBhc3luYyAoeyBhZGRyZXNzLCBjb25uZWN0aW9uIH0pID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoYWRkcmVzcy5lcXVhbHMobWFjKSAmJiBjb25uZWN0aW9uLmRlc2NyaXB0aW9uLm1pYikge1xuICAgICAgICAgICAgaWYgKCFhcmdzLm1pYiB8fCBhcmdzLm1pYiA9PT0gY29ubmVjdGlvbi5kZXNjcmlwdGlvbi5taWIpIHtcbiAgICAgICAgICAgICAgYXdhaXQgcGVyZm9ybShjb25uZWN0aW9uLCBjb25uZWN0aW9uLmRlc2NyaXB0aW9uLm1pYik7XG4gICAgICAgICAgICAgIGlmIChicmVha291dCkgcmV0dXJuIGNsb3NlKCk7XG4gICAgICAgICAgICAgIHdhaXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFkZHJlc3MuZXF1YWxzKG1hYykgJiYgY29ubmVjdGlvbi5kZXNjcmlwdGlvbi50eXBlIHx8IGNvbm5lY3Rpb24uZGVzY3JpcHRpb24ubGluaykge1xuICAgICAgICAgICAgY291bnQgKz0gMTtcbiAgICAgICAgICAgIGNvbnN0IFt2ZXJzaW9uLCB0eXBlXSA9IGF3YWl0IGNvbm5lY3Rpb24uZ2V0VmVyc2lvbihtYWMpO1xuICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgYXdhaXQgcGVyZm9ybShjb25uZWN0aW9uLCB0eXBlLCB2ZXJzaW9uKTtcbiAgICAgICAgICAgICAgaWYgKGJyZWFrb3V0KSByZXR1cm4gY2xvc2UoKTtcbiAgICAgICAgICAgICAgd2FpdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGNsb3NlKGUubWVzc2FnZSB8fCBlKTtcbiAgICAgICAgfVxuICAgICAgICBjb3VudCAtPSAxO1xuICAgICAgICBpZiAoY291bnQgPT09IDApIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjbG9zZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB3YWl0ID0gKCkgPT4ge1xuICAgICAgICBjb3VudCAtPSAxO1xuICAgICAgICBpZiAoY291bnQgPiAwKSB7XG4gICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQod2FpdCwgZ2V0TmlidXNUaW1lb3V0KCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGxldCB0aW1lb3V0ID0gc2V0VGltZW91dCh3YWl0LCBnZXROaWJ1c1RpbWVvdXQoKSk7XG4gICAgfSk7XG5cbmV4cG9ydCB7IG1ha2VBZGRyZXNzSGFuZGxlciB9O1xuIl19