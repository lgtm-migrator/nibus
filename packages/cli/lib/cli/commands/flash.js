"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _crc = require("crc");

var _fs = _interopRequireDefault(require("fs"));

var _lodash = _interopRequireDefault(require("lodash"));

var _progress = _interopRequireDefault(require("progress"));

var _handlers = require("../handlers");

var _write = require("./write");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const domain = 'RFLASH';
const crcPrev = 0xAA55;

const ident = buf => buf;

const createHeader = (kind, option, data) => {
  const buffer = Buffer.alloc(20);
  buffer.write(kind.padEnd(4, '\0'));
  buffer.writeUInt32LE(data.length, 4);
  buffer.writeUInt32LE(Math.round(Date.now() / 1000), 8);
  buffer.writeUInt16LE(option, 16);
  buffer.writeUInt16LE((0, _crc.crc16ccitt)(buffer.slice(0, 18), crcPrev), 18);
  return buffer;
};

const hexToBuf = hex => Buffer.from(hex.split(/[\s:-=]/g).join(''), 'hex');

const txtConvert = buffer => {
  const lines = buffer.toString('ascii').split(/\r?\n/g);
  const result = Buffer.alloc(32768, 0xFF);
  const begin = 0x8000;
  let offset = 0;
  lines.forEach(line => {
    if (line[0] === '@') {
      offset = parseInt(line.slice(1), 16) - begin;
    } else {
      offset += hexToBuf(line).copy(result, offset);
    }
  });
  return result;
};

const decConvert = data => {
  const lines = data.toString().split(/\r?\n/g);

  const raw = _lodash.default.flatten(lines.map(line => line.trim()).filter(line => !!line).map(line => line.split(/\s+/g).map(b => {
    const i = parseInt(b, 10);
    if (Number.isNaN(i)) console.error('Invalid Number', b);
    return i;
  })));

  if (_lodash.default.some(raw, b => Number.isNaN(b))) throw new Error('Invalid number');
  return Buffer.from(_lodash.default.flatten(raw.map(word => [word & 0xFF, word >> 8 & 0xFF])));
};

const meta = {
  rbf: {
    offset: 0x60000,
    size: [368011],
    converter: ident
  },
  tca: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert
  },
  tcc: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert
  },
  ctrl: {
    offset: 0xF0000,
    size: [32768],
    converter: txtConvert
  }
};

async function action(device, args) {
  await (0, _write.action)(device, args);
  const opts = meta[args.kind];
  process.env['NODE_NO_WARNINGS'] = '1';
  let buffer = opts.converter((await _fs.default.promises.readFile(args.source)));

  if (!opts.size.includes(buffer.length)) {
    throw new Error(`Invalid data length. Expected ${opts.size.join(',')} got ${buffer.length}`);
  }

  if (args.kind !== 'ctrl') {
    const header = createHeader(args.kind, 0, buffer);
    buffer = Buffer.concat([header, buffer, header]);
  } else {
    const crc = Buffer.alloc(2);
    crc.writeUInt16LE((0, _crc.crc16ccitt)(buffer, crcPrev), 0);
    buffer = Buffer.concat([buffer, crc]);
  }

  const dest = opts.offset.toString(16).padStart(4, '0');
  const bar = new _progress.default(`  flashing [:bar] to ${dest} :rate/bps :percent :current/:total :etas`, {
    total: buffer.length,
    width: 30
  });
  device.on('downloadData', ({
    domain: downloadDomain,
    length
  }) => {
    if (domain === downloadDomain) bar.tick(length);
  });
  await device.download(domain, buffer, opts.offset);

  if (args.execute) {
    await device.execute(args.execute);
  }
}

const flashCommand = {
  command: 'flash',
  describe: 'прошивка минихоста3',
  builder: argv => argv.option('kind', {
    alias: 'k',
    choices: ['rbf', 'tca', 'tcc', 'ctrl']
  }) // .option('offset', {
  //   alias: 'ofs',
  //   default: 0,
  //   number: true,
  //   describe: 'смещение в домене',
  // })
  .option('source', {
    alias: 'src',
    string: true,
    describe: 'загрузить данные из файла'
  }).option('execute', {
    alias: 'exec',
    string: true,
    describe: 'выполнить программу после записи'
  }) // .option('hex', {
  //   boolean: true,
  //   describe: 'использовать шестнадцатиричный формат',
  // })
  // .option('dec', {
  //   boolean: true,
  //   describe: 'использовать десятичный двубайтный формат',
  // })
  // .conflicts('hex', 'dec')
  .example('flash', '$0 flash -m ::1 -k ctrl moduleSelect=0 --src Slim_Ctrl_v5_Mcu_v1.2.txt --exec update').demandOption(['mac', 'm', 'kind', 'source']),
  handler: (0, _handlers.makeAddressHandler)(action)
};
var _default = flashCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZmxhc2gudHMiXSwibmFtZXMiOlsiZG9tYWluIiwiY3JjUHJldiIsImlkZW50IiwiYnVmIiwiY3JlYXRlSGVhZGVyIiwia2luZCIsIm9wdGlvbiIsImRhdGEiLCJidWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsIndyaXRlIiwicGFkRW5kIiwid3JpdGVVSW50MzJMRSIsImxlbmd0aCIsIk1hdGgiLCJyb3VuZCIsIkRhdGUiLCJub3ciLCJ3cml0ZVVJbnQxNkxFIiwic2xpY2UiLCJoZXhUb0J1ZiIsImhleCIsImZyb20iLCJzcGxpdCIsImpvaW4iLCJ0eHRDb252ZXJ0IiwibGluZXMiLCJ0b1N0cmluZyIsInJlc3VsdCIsImJlZ2luIiwib2Zmc2V0IiwiZm9yRWFjaCIsImxpbmUiLCJwYXJzZUludCIsImNvcHkiLCJkZWNDb252ZXJ0IiwicmF3IiwiXyIsImZsYXR0ZW4iLCJtYXAiLCJ0cmltIiwiZmlsdGVyIiwiYiIsImkiLCJOdW1iZXIiLCJpc05hTiIsImNvbnNvbGUiLCJlcnJvciIsInNvbWUiLCJFcnJvciIsIndvcmQiLCJtZXRhIiwicmJmIiwic2l6ZSIsImNvbnZlcnRlciIsInRjYSIsInRjYyIsImN0cmwiLCJhY3Rpb24iLCJkZXZpY2UiLCJhcmdzIiwib3B0cyIsInByb2Nlc3MiLCJlbnYiLCJmcyIsInByb21pc2VzIiwicmVhZEZpbGUiLCJzb3VyY2UiLCJpbmNsdWRlcyIsImhlYWRlciIsImNvbmNhdCIsImNyYyIsImRlc3QiLCJwYWRTdGFydCIsImJhciIsIlByb2dyZXNzIiwidG90YWwiLCJ3aWR0aCIsIm9uIiwiZG93bmxvYWREb21haW4iLCJ0aWNrIiwiZG93bmxvYWQiLCJleGVjdXRlIiwiZmxhc2hDb21tYW5kIiwiY29tbWFuZCIsImRlc2NyaWJlIiwiYnVpbGRlciIsImFyZ3YiLCJhbGlhcyIsImNob2ljZXMiLCJzdHJpbmciLCJleGFtcGxlIiwiZGVtYW5kT3B0aW9uIiwiaGFuZGxlciJd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UCxNQURPLEVBQ0M7QUFDZG1GLElBQUFBLEtBQUssRUFBRSxHQURPO0FBRWRDLElBQUFBLE9BQU8sRUFBRSxDQUFDLEtBQUQsRUFBUSxLQUFSLEVBQWUsS0FBZixFQUFzQixNQUF0QjtBQUZLLEdBREQsRUFLZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFWZSxHQVdkcEYsTUFYYyxDQVdQLFFBWE8sRUFXRztBQUNoQm1GLElBQUFBLEtBQUssRUFBRSxLQURTO0FBRWhCRSxJQUFBQSxNQUFNLEVBQUUsSUFGUTtBQUdoQkwsSUFBQUEsUUFBUSxFQUFFO0FBSE0sR0FYSCxFQWdCZGhGLE1BaEJjLENBZ0JQLFNBaEJPLEVBZ0JJO0FBQ2pCbUYsSUFBQUEsS0FBSyxFQUFFLE1BRFU7QUFFakJFLElBQUFBLE1BQU0sRUFBRSxJQUZTO0FBR2pCTCxJQUFBQSxRQUFRLEVBQUU7QUFITyxHQWhCSixFQXFCZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUE3QmUsR0E4QmRNLE9BOUJjLENBK0JiLE9BL0JhLEVBZ0NiLHNGQWhDYSxFQWtDZEMsWUFsQ2MsQ0FrQ0QsQ0FBQyxLQUFELEVBQVEsR0FBUixFQUFhLE1BQWIsRUFBcUIsUUFBckIsQ0FsQ0MsQ0FId0M7QUFzQ3pEQyxFQUFBQSxPQUFPLEVBQUUsa0NBQW1CbkMsTUFBbkI7QUF0Q2dELENBQTNEO2VBeUNleUIsWSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBOYXRhLUluZm9cbiAqIEBhdXRob3IgQW5kcmVpIFNhcmFrZWV2IDxhdnNAbmF0YS1pbmZvLnJ1PlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBcIkBuYXRhXCIgcHJvamVjdC5cbiAqIEZvciB0aGUgZnVsbCBjb3B5cmlnaHQgYW5kIGxpY2Vuc2UgaW5mb3JtYXRpb24sIHBsZWFzZSB2aWV3XG4gKiB0aGUgRVVMQSBmaWxlIHRoYXQgd2FzIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyBzb3VyY2UgY29kZS5cbiAqL1xuXG5pbXBvcnQgeyBBcmd1bWVudHMsIENvbW1hbmRNb2R1bGUsIERlZmluZWQgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBjcmMxNmNjaXR0IH0gZnJvbSAnY3JjJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFByb2dyZXNzIGZyb20gJ3Byb2dyZXNzJztcblxuaW1wb3J0IHsgSURldmljZSB9IGZyb20gJ0BuaWJ1cy9jb3JlL2xpYi9taWInO1xuaW1wb3J0IHsgbWFrZUFkZHJlc3NIYW5kbGVyIH0gZnJvbSAnLi4vaGFuZGxlcnMnO1xuaW1wb3J0IHsgQ29tbW9uT3B0cyB9IGZyb20gJy4uL29wdGlvbnMnO1xuaW1wb3J0IHsgYWN0aW9uIGFzIHdyaXRlQWN0aW9uIH0gZnJvbSAnLi93cml0ZSc7XG5cbmNvbnN0IGRvbWFpbiA9ICdSRkxBU0gnO1xuY29uc3QgY3JjUHJldiA9IDB4QUE1NTtcblxudHlwZSBLaW5kID0gJ3JiZicgfCAndGNhJyB8ICd0Y2MnIHwgJ2N0cmwnO1xudHlwZSBLaW5kT3B0cyA9IHsgb2Zmc2V0OiBudW1iZXIsIHNpemU6IG51bWJlcltdLCBjb252ZXJ0ZXI6IChidWZmZXI6IEJ1ZmZlcikgPT4gQnVmZmVyIH07XG50eXBlIEtpbmRNZXRhID0gUmVjb3JkPEtpbmQsIEtpbmRPcHRzPjtcblxuY29uc3QgaWRlbnQgPSAoYnVmOiBCdWZmZXIpID0+IGJ1ZjtcblxudHlwZSBGbGFzaE9wdHMgPSBEZWZpbmVkPENvbW1vbk9wdHMsICdtJyB8ICdtYWMnPiAmIHtcbiAga2luZDogc3RyaW5nLFxuICBzb3VyY2U6IHN0cmluZyxcbiAgc3JjPzogc3RyaW5nLFxuICBleGVjdXRlPzogc3RyaW5nLFxuICAvLyBoZXg/OiBib29sZWFuLFxuICAvLyBkZWM/OiBib29sZWFuLFxufTtcblxuY29uc3QgY3JlYXRlSGVhZGVyID0gKGtpbmQ6IHN0cmluZywgb3B0aW9uOiBudW1iZXIsIGRhdGE6IEJ1ZmZlcikgPT4ge1xuICBjb25zdCBidWZmZXIgPSBCdWZmZXIuYWxsb2MoMjApO1xuICBidWZmZXIud3JpdGUoa2luZC5wYWRFbmQoNCwgJ1xcMCcpKTtcbiAgYnVmZmVyLndyaXRlVUludDMyTEUoZGF0YS5sZW5ndGgsIDQpO1xuICBidWZmZXIud3JpdGVVSW50MzJMRShNYXRoLnJvdW5kKERhdGUubm93KCkgLyAxMDAwKSwgOCk7XG4gIGJ1ZmZlci53cml0ZVVJbnQxNkxFKG9wdGlvbiwgMTYpO1xuICBidWZmZXIud3JpdGVVSW50MTZMRShjcmMxNmNjaXR0KGJ1ZmZlci5zbGljZSgwLCAxOCksIGNyY1ByZXYpLCAxOCk7XG4gIHJldHVybiBidWZmZXI7XG59O1xuXG5jb25zdCBoZXhUb0J1ZiA9IChoZXg6IHN0cmluZykgPT4gQnVmZmVyLmZyb20oaGV4LnNwbGl0KC9bXFxzOi09XS9nKS5qb2luKCcnKSwgJ2hleCcpO1xuY29uc3QgdHh0Q29udmVydCA9IChidWZmZXI6IEJ1ZmZlcik6IEJ1ZmZlciA9PiB7XG4gIGNvbnN0IGxpbmVzID0gYnVmZmVyLnRvU3RyaW5nKCdhc2NpaScpLnNwbGl0KC9cXHI/XFxuL2cpO1xuICBjb25zdCByZXN1bHQgPSBCdWZmZXIuYWxsb2MoMzI3NjgsIDB4RkYpO1xuICBjb25zdCBiZWdpbiA9IDB4ODAwMDtcbiAgbGV0IG9mZnNldCA9IDA7XG4gIGxpbmVzLmZvckVhY2goKGxpbmUpID0+IHtcbiAgICBpZiAobGluZVswXSA9PT0gJ0AnKSB7XG4gICAgICBvZmZzZXQgPSBwYXJzZUludChsaW5lLnNsaWNlKDEpLCAxNikgLSBiZWdpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgb2Zmc2V0ICs9IGhleFRvQnVmKGxpbmUpLmNvcHkocmVzdWx0LCBvZmZzZXQpO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBkZWNDb252ZXJ0ID0gKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICBjb25zdCBsaW5lcyA9IGRhdGEudG9TdHJpbmcoKS5zcGxpdCgvXFxyP1xcbi9nKTtcbiAgY29uc3QgcmF3ID0gXy5mbGF0dGVuKGxpbmVzXG4gICAgLm1hcChsaW5lID0+IGxpbmUudHJpbSgpKVxuICAgIC5maWx0ZXIobGluZSA9PiAhIWxpbmUpXG4gICAgLm1hcChsaW5lID0+IGxpbmUuc3BsaXQoL1xccysvZykubWFwKChiKSA9PiB7XG4gICAgICBjb25zdCBpID0gcGFyc2VJbnQoYiwgMTApO1xuICAgICAgaWYgKE51bWJlci5pc05hTihpKSkgY29uc29sZS5lcnJvcignSW52YWxpZCBOdW1iZXInLCBiKTtcbiAgICAgIHJldHVybiBpO1xuICAgIH0pKSk7XG4gIGlmIChfLnNvbWUocmF3LCBiID0+IE51bWJlci5pc05hTihiKSkpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBudW1iZXInKTtcbiAgcmV0dXJuIEJ1ZmZlci5mcm9tKF8uZmxhdHRlbihyYXcubWFwKHdvcmQgPT4gW3dvcmQgJiAweEZGLCAod29yZCA+PiA4KSAmIDB4RkZdKSkpO1xufTtcblxuY29uc3QgbWV0YTogS2luZE1ldGEgPSB7XG4gIHJiZjoge1xuICAgIG9mZnNldDogMHg2MDAwMCxcbiAgICBzaXplOiBbMzY4MDExXSxcbiAgICBjb252ZXJ0ZXI6IGlkZW50LFxuICB9LFxuICB0Y2E6IHtcbiAgICBvZmZzZXQ6IDB4QzAwMDAsXG4gICAgc2l6ZTogWzE1MzYsIDI4MjJdLFxuICAgIGNvbnZlcnRlcjogZGVjQ29udmVydCxcbiAgfSxcbiAgdGNjOiB7XG4gICAgb2Zmc2V0OiAweEMwMDAwLFxuICAgIHNpemU6IFsxNTM2LCAyODIyXSxcbiAgICBjb252ZXJ0ZXI6IGRlY0NvbnZlcnQsXG4gIH0sXG4gIGN0cmw6IHtcbiAgICBvZmZzZXQ6IDB4RjAwMDAsXG4gICAgc2l6ZTogWzMyNzY4XSxcbiAgICBjb252ZXJ0ZXI6IHR4dENvbnZlcnQsXG4gIH0sXG59O1xuXG5hc3luYyBmdW5jdGlvbiBhY3Rpb24oZGV2aWNlOiBJRGV2aWNlLCBhcmdzOiBBcmd1bWVudHM8Rmxhc2hPcHRzPikge1xuICBhd2FpdCB3cml0ZUFjdGlvbihkZXZpY2UsIGFyZ3MpO1xuICBjb25zdCBvcHRzID0gbWV0YVthcmdzLmtpbmQgYXMgS2luZF07XG4gIHByb2Nlc3MuZW52WydOT0RFX05PX1dBUk5JTkdTJ10gPSAnMSc7XG4gIGxldCBidWZmZXIgPSBvcHRzLmNvbnZlcnRlcihhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShhcmdzLnNvdXJjZSkpO1xuICBpZiAoIW9wdHMuc2l6ZS5pbmNsdWRlcyhidWZmZXIubGVuZ3RoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBkYXRhIGxlbmd0aC4gRXhwZWN0ZWQgJHtvcHRzLnNpemUuam9pbignLCcpfSBnb3QgJHtidWZmZXIubGVuZ3RofWApO1xuICB9XG4gIGlmIChhcmdzLmtpbmQgIT09ICdjdHJsJykge1xuICAgIGNvbnN0IGhlYWRlciA9IGNyZWF0ZUhlYWRlcihhcmdzLmtpbmQsIDAsIGJ1ZmZlcik7XG4gICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbaGVhZGVyLCBidWZmZXIsIGhlYWRlcl0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNyYyA9IEJ1ZmZlci5hbGxvYygyKTtcbiAgICBjcmMud3JpdGVVSW50MTZMRShjcmMxNmNjaXR0KGJ1ZmZlciwgY3JjUHJldiksIDApO1xuICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW2J1ZmZlciwgY3JjXSk7XG4gIH1cbiAgY29uc3QgZGVzdCA9IG9wdHMub2Zmc2V0LnRvU3RyaW5nKDE2KS5wYWRTdGFydCg0LCAnMCcpO1xuICBjb25zdCBiYXIgPSBuZXcgUHJvZ3Jlc3MoXG4gICAgYCAgZmxhc2hpbmcgWzpiYXJdIHRvICR7ZGVzdH0gOnJhdGUvYnBzIDpwZXJjZW50IDpjdXJyZW50Lzp0b3RhbCA6ZXRhc2AsXG4gICAge1xuICAgICAgdG90YWw6IGJ1ZmZlci5sZW5ndGgsXG4gICAgICB3aWR0aDogMzAsXG4gICAgfSxcbiAgKTtcbiAgZGV2aWNlLm9uKCdkb3dubG9hZERhdGEnLCAoeyBkb21haW46IGRvd25sb2FkRG9tYWluLCBsZW5ndGggfSkgPT4ge1xuICAgIGlmIChkb21haW4gPT09IGRvd25sb2FkRG9tYWluKSBiYXIudGljayhsZW5ndGgpO1xuICB9KTtcblxuICBhd2FpdCBkZXZpY2UuZG93bmxvYWQoZG9tYWluLCBidWZmZXIsIG9wdHMub2Zmc2V0KTtcbiAgaWYgKGFyZ3MuZXhlY3V0ZSkge1xuICAgIGF3YWl0IGRldmljZS5leGVjdXRlKGFyZ3MuZXhlY3V0ZSk7XG4gIH1cbn1cblxuY29uc3QgZmxhc2hDb21tYW5kOiBDb21tYW5kTW9kdWxlPENvbW1vbk9wdHMsIEZsYXNoT3B0cz4gPSB7XG4gIGNvbW1hbmQ6ICdmbGFzaCcsXG4gIGRlc2NyaWJlOiAn0L/RgNC+0YjQuNCy0LrQsCDQvNC40L3QuNGF0L7RgdGC0LAzJyxcbiAgYnVpbGRlcjogYXJndiA9PiBhcmd2XG4gICAgLm9wdGlvbigna2luZCcsIHtcbiAgICAgIGFsaWFzOiAnaycsXG4gICAgICBjaG9pY2VzOiBbJ3JiZicsICd0Y2EnLCAndGNjJywgJ2N0cmwnXSxcbiAgICB9KVxuICAgIC8vIC5vcHRpb24oJ29mZnNldCcsIHtcbiAgICAvLyAgIGFsaWFzOiAnb2ZzJyxcbiAgICAvLyAgIGRlZmF1bHQ6IDAsXG4gICAgLy8gICBudW1iZXI6IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9GB0LzQtdGJ0LXQvdC40LUg0LIg0LTQvtC80LXQvdC1JyxcbiAgICAvLyB9KVxuICAgIC5vcHRpb24oJ3NvdXJjZScsIHtcbiAgICAgIGFsaWFzOiAnc3JjJyxcbiAgICAgIHN0cmluZzogdHJ1ZSxcbiAgICAgIGRlc2NyaWJlOiAn0LfQsNCz0YDRg9C30LjRgtGMINC00LDQvdC90YvQtSDQuNC3INGE0LDQudC70LAnLFxuICAgIH0pXG4gICAgLm9wdGlvbignZXhlY3V0ZScsIHtcbiAgICAgIGFsaWFzOiAnZXhlYycsXG4gICAgICBzdHJpbmc6IHRydWUsXG4gICAgICBkZXNjcmliZTogJ9Cy0YvQv9C+0LvQvdC40YLRjCDQv9GA0L7Qs9GA0LDQvNC80YMg0L/QvtGB0LvQtSDQt9Cw0L/QuNGB0LgnLFxuICAgIH0pXG4gICAgLy8gLm9wdGlvbignaGV4Jywge1xuICAgIC8vICAgYm9vbGVhbjogdHJ1ZSxcbiAgICAvLyAgIGRlc2NyaWJlOiAn0LjRgdC/0L7Qu9GM0LfQvtCy0LDRgtGMINGI0LXRgdGC0L3QsNC00YbQsNGC0LjRgNC40YfQvdGL0Lkg0YTQvtGA0LzQsNGCJyxcbiAgICAvLyB9KVxuICAgIC8vIC5vcHRpb24oJ2RlYycsIHtcbiAgICAvLyAgIGJvb2xlYW46IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9C40YHQv9C+0LvRjNC30L7QstCw0YLRjCDQtNC10YHRj9GC0LjRh9C90YvQuSDQtNCy0YPQsdCw0LnRgtC90YvQuSDRhNC+0YDQvNCw0YInLFxuICAgIC8vIH0pXG4gICAgLy8gLmNvbmZsaWN0cygnaGV4JywgJ2RlYycpXG4gICAgLmV4YW1wbGUoXG4gICAgICAnZmxhc2gnLFxuICAgICAgJyQwIGZsYXNoIC1tIDo6MSAtayBjdHJsIG1vZHVsZVNlbGVjdD0wIC0tc3JjIFNsaW1fQ3RybF92NV9NY3VfdjEuMi50eHQgLS1leGVjIHVwZGF0ZScsXG4gICAgKVxuICAgIC5kZW1hbmRPcHRpb24oWydtYWMnLCAnbScsICdraW5kJywgJ3NvdXJjZSddKSxcbiAgaGFuZGxlcjogbWFrZUFkZHJlc3NIYW5kbGVyKGFjdGlvbiksXG59O1xuXG5leHBvcnQgZGVmYXVsdCBmbGFzaENvbW1hbmQ7XG4iXX0=