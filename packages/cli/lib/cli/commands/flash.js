"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _crc = require("crc");

var _fs = _interopRequireDefault(require("fs"));

var _lodash = _interopRequireDefault(require("lodash"));

var _progress = _interopRequireDefault(require("progress"));

var _fastXmlParser = _interopRequireDefault(require("fast-xml-parser"));

var _path = _interopRequireDefault(require("path"));

var _handlers = require("../handlers");

var _write = require("./write");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const domain = 'RFLASH';
const crcPrev = 0xAA55;

const ident = buf => buf;

const createHeader = (kind, option, data) => {
  const buffer = Buffer.alloc(20);
  buffer.write(kind.padEnd(4, '\0'));
  buffer.writeUInt32LE(data.length, 4);
  buffer.writeUInt32LE(Math.round(Date.now() / 1000), 8);
  buffer.writeUInt16LE(option, 16);
  buffer.writeUInt16LE((0, _crc.crc16ccitt)(buffer.slice(0, 18), crcPrev), 18);
  return buffer;
};

const hexToBuf = hex => Buffer.from(hex.replace(/[\s:-=]/g, ''), 'hex');

const txtConvert = buffer => {
  const lines = buffer.toString('ascii').split(/\r?\n/g);
  const result = Buffer.alloc(32768, 0xFF);
  const begin = 0x8000;
  let offset = 0;
  lines.forEach(line => {
    if (line[0] === '@') {
      offset = parseInt(line.slice(1), 16) - begin;
    } else if (line === 'q') {} else {
      const buf = hexToBuf(line); // console.log(offset, buf);

      offset += buf.copy(result, offset);
    }
  });
  return result;
};

const decConvert = data => {
  const lines = data.toString().split(/\r?\n/g);

  const raw = _lodash.default.flatten(lines.map(line => line.trim()).filter(line => !!line).map(line => line.split(/\s+/g).map(b => {
    const i = parseInt(b, 10);
    if (Number.isNaN(i)) console.error('Invalid Number', b);
    return i;
  })));

  if (_lodash.default.some(raw, b => Number.isNaN(b))) throw new Error('Invalid number');
  return Buffer.from(_lodash.default.flatten(raw.map(word => [word & 0xFF, word >> 8 & 0xFF])));
};

const xmlConvert = data => {
  const xml = data.toString();

  const valid = _fastXmlParser.default.validate(xml);

  if (valid !== true) {
    throw new Error(valid.err.msg);
  }

  const {
    Configuration = null
  } = _fastXmlParser.default.parse(xml);

  if (!Configuration) throw new Error('Invalid xml config');
  const buffer = Buffer.alloc(140, 0);
  let offset = 0;
  ['RedLedMeasurement', 'GreenLedMeasurement', 'BlueLedMeasurement'].forEach(name => {
    const {
      Xy: {
        X,
        Y
      },
      Yb
    } = Configuration[name];
    offset = buffer.writeFloatLE(X, offset);
    offset = buffer.writeFloatLE(Y, offset);
    offset = buffer.writeFloatLE(Yb, offset);
  });
  ['RedLedTermCompFactors', 'GreenLedTermCompFactors', 'BlueLedTermCompFactors'].forEach(name => {
    const {
      A,
      B,
      C
    } = Configuration[name];
    offset = buffer.writeFloatLE(A, offset);
    offset = buffer.writeFloatLE(B, offset);
    offset = buffer.writeFloatLE(C, offset);
  });
  let last = offset;
  ['HostBrightSetting', 'CalibrationBright', 'RedVertexOfTriangle.X', 'RedVertexOfTriangle.Y', 'GreenVertexOfTriangle.X', 'GreenVertexOfTriangle.Y', 'BlueVertexOfTriangle.X', 'BlueVertexOfTriangle.Y', 'RedVertexXBase', 'RedVertexYBase', 'RedVertexStep', 'GreenVertexXBase', 'GreenVertexYBase', 'GreenVertexStep', 'BlueVertexXBase', 'BlueVertexYBase', 'BlueVertexStep'].forEach(prop => {
    const value = _lodash.default.get(Configuration, prop, 0);

    offset = buffer.writeFloatLE(value, offset);
    if (value > 0) last = offset;
  });
  console.assert(offset === 140, 'Invalid buffer size');
  return buffer.slice(0, last);
};

const meta = {
  rbf: {
    offset: 0x60000,
    size: [368011],
    converter: ident,
    exec: 'reload'
  },
  tca: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert,
    exec: 'reload'
  },
  tcc: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert,
    exec: 'reload'
  },
  ttc: {
    offset: 0xC0000,
    converter: xmlConvert,
    exec: 'reload'
  },
  ctrl: {
    offset: 0xF0000,
    size: [32768],
    converter: txtConvert,
    exec: 'update'
  }
};

async function action(device, args) {
  await (0, _write.action)(device, args);
  let kind = args.kind;

  if (!kind) {
    switch (_path.default.extname(args.source)) {
      case '.rbf':
        kind = 'rbf';
        break;

      case '.tcc':
        kind = 'tcc';
        break;

      case '.tca':
        kind = 'tca';
        break;

      case '.xml':
        kind = 'ttc';
        break;

      case '.txt':
        kind = 'ctrl';
        break;

      default:
        throw new Error('Unknown kind of source');
    }
  }

  const opts = meta[kind];
  process.env['NODE_NO_WARNINGS'] = '1';
  let buffer = opts.converter((await _fs.default.promises.readFile(args.source)));

  if (opts.size && !opts.size.includes(buffer.length)) {
    throw new Error(`Invalid data length. Expected ${opts.size.join(',')} got ${buffer.length}`);
  }

  if (kind !== 'ctrl') {
    const header = createHeader(kind, 0, buffer);
    buffer = Buffer.concat([header, buffer, header]);
  } else {
    const crc = Buffer.alloc(2);
    crc.writeUInt16LE((0, _crc.crc16ccitt)(buffer, 0x55AA), 0);
    buffer = Buffer.concat([buffer, crc]);
  }

  const dest = opts.offset.toString(16).padStart(4, '0');
  const bar = new _progress.default(`  flashing [:bar] to ${dest} :rate/bps :percent :current/:total :etas`, {
    total: buffer.length,
    width: 30
  });
  device.on('downloadData', ({
    domain: downloadDomain,
    length
  }) => {
    if (domain === downloadDomain) bar.tick(length);
  });
  await device.download(domain, buffer, opts.offset);
  device.selector = 0;
  await device.write(device.getId('selector'));
  const data = await device.upload('MODUL', 0, 6); // console.log('RESULT', data[3].toString(2), data);

  if (data[3] & 0b100) {
    console.error('Ошибка контрольной суммы в кадре');
  }

  if (data[3] & 0b1000) {
    console.error('Таймаут ожидания валидности страницы');
  }

  if (data[3] & 0b10000) {
    console.error('Ошибка в работе флеш памяти');
  }

  if (opts.exec) {
    await device.execute(opts.exec);
  } // console.log('BUFFER', buffer.slice(0, 80).toString('hex'));

}

const flashCommand = {
  command: 'flash',
  describe: 'прошивка минихоста3',
  builder: argv => argv.option('kind', {
    alias: 'k',
    choices: ['rbf', 'tca', 'tcc', 'ttc', 'ctrl']
  }) // .option('offset', {
  //   alias: 'ofs',
  //   default: 0,
  //   number: true,
  //   describe: 'смещение в домене',
  // })
  .option('source', {
    alias: 'src',
    string: true,
    describe: 'загрузить данные из файла'
  }) // .option('execute', {
  //   alias: 'exec',
  //   string: true,
  //   describe: 'выполнить программу после записи',
  // })
  // .option('hex', {
  //   boolean: true,
  //   describe: 'использовать шестнадцатиричный формат',
  // })
  // .option('dec', {
  //   boolean: true,
  //   describe: 'использовать десятичный двубайтный формат',
  // })
  // .conflicts('hex', 'dec')
  .example('$0 flash -m ::1 -k rbf moduleSelect=0 --src Alpha_Ctrl_SPI_Module_C10_320_104.rbf', 'Прошивка ПЛИС (если расширение .rbf, [-k rbf] - можно не указывать) ').example('$0 flash -m ::1 -k tcc moduleSelect=0 --src data.tcc', 'Прошивка таблицы цветокоррекции v1 (если расширение .tcc, [-k tcc] - можно не указывать)').example('$0 flash -m ::1 -k ttc moduleSelect=0 --src config.xml', 'Прошивка таблицы цветокоррекции v2 (если расширение .xml, [-k ttc] - можно не указывать)').example('$0 flash -m ::1 -k ctrl moduleSelect=0 --src Slim_Ctrl_v5_Mcu_v1.2.txt', 'Прошивка процессора (если расширение .txt, [-k ctrl] - можно не указывать)').demandOption(['mac', 'm', 'source']),
  handler: (0, _handlers.makeAddressHandler)(action)
};
var _default = flashCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZmxhc2gudHMiXSwibmFtZXMiOlsiZG9tYWluIiwiY3JjUHJldiIsImlkZW50IiwiYnVmIiwiY3JlYXRlSGVhZGVyIiwia2luZCIsIm9wdGlvbiIsImRhdGEiLCJidWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsIndyaXRlIiwicGFkRW5kIiwid3JpdGVVSW50MzJMRSIsImxlbmd0aCIsIk1hdGgiLCJyb3VuZCIsIkRhdGUiLCJub3ciLCJ3cml0ZVVJbnQxNkxFIiwic2xpY2UiLCJoZXhUb0J1ZiIsImhleCIsImZyb20iLCJyZXBsYWNlIiwidHh0Q29udmVydCIsImxpbmVzIiwidG9TdHJpbmciLCJzcGxpdCIsInJlc3VsdCIsImJlZ2luIiwib2Zmc2V0IiwiZm9yRWFjaCIsImxpbmUiLCJwYXJzZUludCIsImNvcHkiLCJkZWNDb252ZXJ0IiwicmF3IiwiXyIsImZsYXR0ZW4iLCJtYXAiLCJ0cmltIiwiZmlsdGVyIiwiYiIsImkiLCJOdW1iZXIiLCJpc05hTiIsImNvbnNvbGUiLCJlcnJvciIsInNvbWUiLCJFcnJvciIsIndvcmQiLCJ4bWxDb252ZXJ0IiwieG1sIiwidmFsaWQiLCJ4bWxQYXJzZXIiLCJ2YWxpZGF0ZSIsImVyciIsIm1zZyIsIkNvbmZpZ3VyYXRpb24iLCJwYXJzZSIsIm5hbWUiLCJYeSIsIlgiLCJZIiwiWWIiLCJ3cml0ZUZsb2F0TEUiLCJBIiwiQiIsIkMiLCJsYXN0IiwicHJvcCIsInZhbHVlIiwiZ2V0IiwiYXNzZXJ0IiwibWV0YSIsInJiZiIsInNpemUiLCJjb252ZXJ0ZXIiLCJleGVjIiwidGNhIiwidGNjIiwidHRjIiwiY3RybCIsImFjdGlvbiIsImRldmljZSIsImFyZ3MiLCJwYXRoIiwiZXh0bmFtZSIsInNvdXJjZSIsIm9wdHMiLCJwcm9jZXNzIiwiZW52IiwiZnMiLCJwcm9taXNlcyIsInJlYWRGaWxlIiwiaW5jbHVkZXMiLCJqb2luIiwiaGVhZGVyIiwiY29uY2F0IiwiY3JjIiwiZGVzdCIsInBhZFN0YXJ0IiwiYmFyIiwiUHJvZ3Jlc3MiLCJ0b3RhbCIsIndpZHRoIiwib24iLCJkb3dubG9hZERvbWFpbiIsInRpY2siLCJkb3dubG9hZCIsInNlbGVjdG9yIiwiZ2V0SWQiLCJ1cGxvYWQiLCJleGVjdXRlIiwiZmxhc2hDb21tYW5kIiwiY29tbWFuZCIsImRlc2NyaWJlIiwiYnVpbGRlciIsImFyZ3YiLCJhbGlhcyIsImNob2ljZXMiLCJzdHJpbmciLCJleGFtcGxlIiwiZGVtYW5kT3B0aW9uIiwiaGFuZGxlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBV0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUE7Ozs7QUFFQSxNQUFNQSxNQUFNLEdBQUcsUUFBZjtBQUNBLE1BQU1DLE9BQU8sR0FBRyxNQUFoQjs7QUFZQSxNQUFNQyxLQUFLLEdBQUlDLEdBQUQsSUFBaUJBLEdBQS9COztBQVdBLE1BQU1DLFlBQVksR0FBRyxDQUFDQyxJQUFELEVBQWVDLE1BQWYsRUFBK0JDLElBQS9CLEtBQWdEO0FBQ25FLFFBQU1DLE1BQU0sR0FBR0MsTUFBTSxDQUFDQyxLQUFQLENBQWEsRUFBYixDQUFmO0FBQ0FGLEVBQUFBLE1BQU0sQ0FBQ0csS0FBUCxDQUFhTixJQUFJLENBQUNPLE1BQUwsQ0FBWSxDQUFaLEVBQWUsSUFBZixDQUFiO0FBQ0FKLEVBQUFBLE1BQU0sQ0FBQ0ssYUFBUCxDQUFxQk4sSUFBSSxDQUFDTyxNQUExQixFQUFrQyxDQUFsQztBQUNBTixFQUFBQSxNQUFNLENBQUNLLGFBQVAsQ0FBcUJFLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxJQUFJLENBQUNDLEdBQUwsS0FBYSxJQUF4QixDQUFyQixFQUFvRCxDQUFwRDtBQUNBVixFQUFBQSxNQUFNLENBQUNXLGFBQVAsQ0FBcUJiLE1BQXJCLEVBQTZCLEVBQTdCO0FBQ0FFLEVBQUFBLE1BQU0sQ0FBQ1csYUFBUCxDQUFxQixxQkFBV1gsTUFBTSxDQUFDWSxLQUFQLENBQWEsQ0FBYixFQUFnQixFQUFoQixD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O0FBR2hCTCxJQUFBQSxRQUFRLEVBQUU7QUFITSxHQVhILEVBZ0JmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUE3QmUsR0E4QmRNLE9BOUJjLENBK0JiLG1GQS9CYSxFQWdDYixzRUFoQ2EsRUFrQ2RBLE9BbENjLENBbUNiLHNEQW5DYSxFQW9DYiwwRkFwQ2EsRUFzQ2RBLE9BdENjLENBdUNiLHdEQXZDYSxFQXdDYiwwRkF4Q2EsRUEwQ2RBLE9BMUNjLENBMkNiLHdFQTNDYSxFQTRDYiw0RUE1Q2EsRUE4Q2RDLFlBOUNjLENBOENELENBQUMsS0FBRCxFQUFRLEdBQVIsRUFBYSxRQUFiLENBOUNDLENBSHdDO0FBa0R6REMsRUFBQUEsT0FBTyxFQUFFLGtDQUFtQnpDLE1BQW5CO0FBbERnRCxDQUEzRDtlQXFEZStCLFkiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoYykgMjAxOS4gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IHsgQXJndW1lbnRzLCBDb21tYW5kTW9kdWxlLCBEZWZpbmVkIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgY3JjMTZjY2l0dCB9IGZyb20gJ2NyYyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQcm9ncmVzcyBmcm9tICdwcm9ncmVzcyc7XG5pbXBvcnQgeG1sUGFyc2VyIGZyb20gJ2Zhc3QteG1sLXBhcnNlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgSURldmljZSB9IGZyb20gJ0BuaWJ1cy9jb3JlL2xpYi9taWInO1xuaW1wb3J0IHsgbWFrZUFkZHJlc3NIYW5kbGVyIH0gZnJvbSAnLi4vaGFuZGxlcnMnO1xuaW1wb3J0IHsgQ29tbW9uT3B0cyB9IGZyb20gJy4uL29wdGlvbnMnO1xuaW1wb3J0IHsgYWN0aW9uIGFzIHdyaXRlQWN0aW9uIH0gZnJvbSAnLi93cml0ZSc7XG5cbmNvbnN0IGRvbWFpbiA9ICdSRkxBU0gnO1xuY29uc3QgY3JjUHJldiA9IDB4QUE1NTtcblxudHlwZSBLaW5kID0gJ3JiZicgfCAndGNhJyB8ICd0Y2MnIHwgJ3R0YycgfCAnY3RybCc7XG50eXBlIEtpbmRPcHRzID0ge1xuICBvZmZzZXQ6IG51bWJlcixcbiAgc2l6ZT86IG51bWJlcltdLFxuICBjb252ZXJ0ZXI6IChidWZmZXI6IEJ1ZmZlcikgPT4gQnVmZmVyLFxuICBleGVjPzogJ3JlbG9hZCcgfCAndXBkYXRlJyxcbiAgLy8ga2luZD86ICdyYmYnIHwgJ3RjYScgfCAndGNjJyxcbn07XG50eXBlIEtpbmRNZXRhID0gUmVjb3JkPEtpbmQsIEtpbmRPcHRzPjtcblxuY29uc3QgaWRlbnQgPSAoYnVmOiBCdWZmZXIpID0+IGJ1ZjtcblxudHlwZSBGbGFzaE9wdHMgPSBEZWZpbmVkPENvbW1vbk9wdHMsICdtJyB8ICdtYWMnPiAmIHtcbiAga2luZD86IHN0cmluZyxcbiAgc291cmNlOiBzdHJpbmcsXG4gIHNyYz86IHN0cmluZyxcbiAgZXhlY3V0ZT86IHN0cmluZyxcbiAgLy8gaGV4PzogYm9vbGVhbixcbiAgLy8gZGVjPzogYm9vbGVhbixcbn07XG5cbmNvbnN0IGNyZWF0ZUhlYWRlciA9IChraW5kOiBzdHJpbmcsIG9wdGlvbjogbnVtYmVyLCBkYXRhOiBCdWZmZXIpID0+IHtcbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jKDIwKTtcbiAgYnVmZmVyLndyaXRlKGtpbmQucGFkRW5kKDQsICdcXDAnKSk7XG4gIGJ1ZmZlci53cml0ZVVJbnQzMkxFKGRhdGEubGVuZ3RoLCA0KTtcbiAgYnVmZmVyLndyaXRlVUludDMyTEUoTWF0aC5yb3VuZChEYXRlLm5vdygpIC8gMTAwMCksIDgpO1xuICBidWZmZXIud3JpdGVVSW50MTZMRShvcHRpb24sIDE2KTtcbiAgYnVmZmVyLndyaXRlVUludDE2TEUoY3JjMTZjY2l0dChidWZmZXIuc2xpY2UoMCwgMTgpLCBjcmNQcmV2KSwgMTgpO1xuICByZXR1cm4gYnVmZmVyO1xufTtcblxuY29uc3QgaGV4VG9CdWYgPSAoaGV4OiBzdHJpbmcpID0+IEJ1ZmZlci5mcm9tKGhleC5yZXBsYWNlKC9bXFxzOi09XS9nLCAnJyksICdoZXgnKTtcbmNvbnN0IHR4dENvbnZlcnQgPSAoYnVmZmVyOiBCdWZmZXIpOiBCdWZmZXIgPT4ge1xuICBjb25zdCBsaW5lcyA9IGJ1ZmZlci50b1N0cmluZygnYXNjaWknKS5zcGxpdCgvXFxyP1xcbi9nKTtcbiAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmFsbG9jKDMyNzY4LCAweEZGKTtcbiAgY29uc3QgYmVnaW4gPSAweDgwMDA7XG4gIGxldCBvZmZzZXQgPSAwO1xuICBsaW5lcy5mb3JFYWNoKChsaW5lKSA9PiB7XG4gICAgaWYgKGxpbmVbMF0gPT09ICdAJykge1xuICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQobGluZS5zbGljZSgxKSwgMTYpIC0gYmVnaW47XG4gICAgfSBlbHNlIGlmIChsaW5lID09PSAncScpIHtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYnVmID0gaGV4VG9CdWYobGluZSk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhvZmZzZXQsIGJ1Zik7XG4gICAgICBvZmZzZXQgKz0gYnVmLmNvcHkocmVzdWx0LCBvZmZzZXQpO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBkZWNDb252ZXJ0ID0gKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICBjb25zdCBsaW5lcyA9IGRhdGEudG9TdHJpbmcoKS5zcGxpdCgvXFxyP1xcbi9nKTtcbiAgY29uc3QgcmF3ID0gXy5mbGF0dGVuKGxpbmVzXG4gICAgLm1hcChsaW5lID0+IGxpbmUudHJpbSgpKVxuICAgIC5maWx0ZXIobGluZSA9PiAhIWxpbmUpXG4gICAgLm1hcChsaW5lID0+IGxpbmUuc3BsaXQoL1xccysvZykubWFwKChiKSA9PiB7XG4gICAgICBjb25zdCBpID0gcGFyc2VJbnQoYiwgMTApO1xuICAgICAgaWYgKE51bWJlci5pc05hTihpKSkgY29uc29sZS5lcnJvcignSW52YWxpZCBOdW1iZXInLCBiKTtcbiAgICAgIHJldHVybiBpO1xuICAgIH0pKSk7XG4gIGlmIChfLnNvbWUocmF3LCBiID0+IE51bWJlci5pc05hTihiKSkpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBudW1iZXInKTtcbiAgcmV0dXJuIEJ1ZmZlci5mcm9tKF8uZmxhdHRlbihyYXcubWFwKHdvcmQgPT4gW3dvcmQgJiAweEZGLCAod29yZCA+PiA4KSAmIDB4RkZdKSkpO1xufTtcblxuY29uc3QgeG1sQ29udmVydCA9IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgY29uc3QgeG1sID0gZGF0YS50b1N0cmluZygpO1xuICBjb25zdCB2YWxpZCA9IHhtbFBhcnNlci52YWxpZGF0ZSh4bWwpO1xuICBpZiAodmFsaWQgIT09IHRydWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IodmFsaWQuZXJyLm1zZyk7XG4gIH1cbiAgY29uc3QgeyBDb25maWd1cmF0aW9uID0gbnVsbCB9ID0geG1sUGFyc2VyLnBhcnNlKHhtbCk7XG4gIGlmICghQ29uZmlndXJhdGlvbikgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHhtbCBjb25maWcnKTtcbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jKDE0MCwgMCk7XG4gIGxldCBvZmZzZXQgPSAwO1xuICBbJ1JlZExlZE1lYXN1cmVtZW50JywgJ0dyZWVuTGVkTWVhc3VyZW1lbnQnLCAnQmx1ZUxlZE1lYXN1cmVtZW50J10uZm9yRWFjaCgobmFtZSkgPT4ge1xuICAgIGNvbnN0IHsgWHk6IHsgWCwgWSB9LCBZYiB9OiB7IFh5OiB7IFg6IG51bWJlciwgWTogbnVtYmVyIH0sIFliOiBudW1iZXIgfSA9IENvbmZpZ3VyYXRpb25bbmFtZV07XG4gICAgb2Zmc2V0ID0gYnVmZmVyLndyaXRlRmxvYXRMRShYLCBvZmZzZXQpO1xuICAgIG9mZnNldCA9IGJ1ZmZlci53cml0ZUZsb2F0TEUoWSwgb2Zmc2V0KTtcbiAgICBvZmZzZXQgPSBidWZmZXIud3JpdGVGbG9hdExFKFliLCBvZmZzZXQpO1xuICB9KTtcbiAgWydSZWRMZWRUZXJtQ29tcEZhY3RvcnMnLCAnR3JlZW5MZWRUZXJtQ29tcEZhY3RvcnMnLCAnQmx1ZUxlZFRlcm1Db21wRmFjdG9ycyddLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICBjb25zdCB7IEEsIEIsIEMgfTogeyBBOiBudW1iZXIsIEI6IG51bWJlciwgQzogbnVtYmVyIH0gPSBDb25maWd1cmF0aW9uW25hbWVdO1xuICAgIG9mZnNldCA9IGJ1ZmZlci53cml0ZUZsb2F0TEUoQSwgb2Zmc2V0KTtcbiAgICBvZmZzZXQgPSBidWZmZXIud3JpdGVGbG9hdExFKEIsIG9mZnNldCk7XG4gICAgb2Zmc2V0ID0gYnVmZmVyLndyaXRlRmxvYXRMRShDLCBvZmZzZXQpO1xuICB9KTtcbiAgbGV0IGxhc3QgPSBvZmZzZXQ7XG4gIFtcbiAgICAnSG9zdEJyaWdodFNldHRpbmcnLFxuICAgICdDYWxpYnJhdGlvbkJyaWdodCcsXG4gICAgJ1JlZFZlcnRleE9mVHJpYW5nbGUuWCcsXG4gICAgJ1JlZFZlcnRleE9mVHJpYW5nbGUuWScsXG4gICAgJ0dyZWVuVmVydGV4T2ZUcmlhbmdsZS5YJyxcbiAgICAnR3JlZW5WZXJ0ZXhPZlRyaWFuZ2xlLlknLFxuICAgICdCbHVlVmVydGV4T2ZUcmlhbmdsZS5YJyxcbiAgICAnQmx1ZVZlcnRleE9mVHJpYW5nbGUuWScsXG4gICAgJ1JlZFZlcnRleFhCYXNlJyxcbiAgICAnUmVkVmVydGV4WUJhc2UnLFxuICAgICdSZWRWZXJ0ZXhTdGVwJyxcbiAgICAnR3JlZW5WZXJ0ZXhYQmFzZScsXG4gICAgJ0dyZWVuVmVydGV4WUJhc2UnLFxuICAgICdHcmVlblZlcnRleFN0ZXAnLFxuICAgICdCbHVlVmVydGV4WEJhc2UnLFxuICAgICdCbHVlVmVydGV4WUJhc2UnLFxuICAgICdCbHVlVmVydGV4U3RlcCcsXG4gIF0uZm9yRWFjaCgocHJvcCkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gXy5nZXQoQ29uZmlndXJhdGlvbiwgcHJvcCwgMCk7XG4gICAgb2Zmc2V0ID0gYnVmZmVyLndyaXRlRmxvYXRMRSh2YWx1ZSwgb2Zmc2V0KTtcbiAgICBpZiAodmFsdWUgPiAwKSBsYXN0ID0gb2Zmc2V0O1xuICB9KTtcbiAgY29uc29sZS5hc3NlcnQob2Zmc2V0ID09PSAxNDAsICdJbnZhbGlkIGJ1ZmZlciBzaXplJyk7XG4gIHJldHVybiBidWZmZXIuc2xpY2UoMCwgbGFzdCk7XG59O1xuXG5jb25zdCBtZXRhOiBLaW5kTWV0YSA9IHtcbiAgcmJmOiB7XG4gICAgb2Zmc2V0OiAweDYwMDAwLFxuICAgIHNpemU6IFszNjgwMTFdLFxuICAgIGNvbnZlcnRlcjogaWRlbnQsXG4gICAgZXhlYzogJ3JlbG9hZCcsXG4gIH0sXG4gIHRjYToge1xuICAgIG9mZnNldDogMHhDMDAwMCxcbiAgICBzaXplOiBbMTUzNiwgMjgyMl0sXG4gICAgY29udmVydGVyOiBkZWNDb252ZXJ0LFxuICAgIGV4ZWM6ICdyZWxvYWQnLFxuICB9LFxuICB0Y2M6IHtcbiAgICBvZmZzZXQ6IDB4QzAwMDAsXG4gICAgc2l6ZTogWzE1MzYsIDI4MjJdLFxuICAgIGNvbnZlcnRlcjogZGVjQ29udmVydCxcbiAgICBleGVjOiAncmVsb2FkJyxcbiAgfSxcbiAgdHRjOiB7XG4gICAgb2Zmc2V0OiAweEMwMDAwLFxuICAgIGNvbnZlcnRlcjogeG1sQ29udmVydCxcbiAgICBleGVjOiAncmVsb2FkJyxcbiAgfSxcbiAgY3RybDoge1xuICAgIG9mZnNldDogMHhGMDAwMCxcbiAgICBzaXplOiBbMzI3NjhdLFxuICAgIGNvbnZlcnRlcjogdHh0Q29udmVydCxcbiAgICBleGVjOiAndXBkYXRlJyxcbiAgfSxcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGFjdGlvbihkZXZpY2U6IElEZXZpY2UsIGFyZ3M6IEFyZ3VtZW50czxGbGFzaE9wdHM+KSB7XG4gIGF3YWl0IHdyaXRlQWN0aW9uKGRldmljZSwgYXJncyk7XG4gIGxldCBraW5kOiBLaW5kID0gYXJncy5raW5kIGFzIEtpbmQ7XG4gIGlmICgha2luZCkge1xuICAgIHN3aXRjaCAocGF0aC5leHRuYW1lKGFyZ3Muc291cmNlKSkge1xuICAgICAgY2FzZSAnLnJiZic6XG4gICAgICAgIGtpbmQgPSAncmJmJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICcudGNjJzpcbiAgICAgICAga2luZCA9ICd0Y2MnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJy50Y2EnOlxuICAgICAgICBraW5kID0gJ3RjYSc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnLnhtbCc6XG4gICAgICAgIGtpbmQgPSAndHRjJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICcudHh0JzpcbiAgICAgICAga2luZCA9ICdjdHJsJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24ga2luZCBvZiBzb3VyY2UnKTtcbiAgICB9XG4gIH1cbiAgY29uc3Qgb3B0cyA9IG1ldGFba2luZF07XG4gIHByb2Nlc3MuZW52WydOT0RFX05PX1dBUk5JTkdTJ10gPSAnMSc7XG4gIGxldCBidWZmZXIgPSBvcHRzLmNvbnZlcnRlcihhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShhcmdzLnNvdXJjZSkpO1xuICBpZiAob3B0cy5zaXplICYmICFvcHRzLnNpemUuaW5jbHVkZXMoYnVmZmVyLmxlbmd0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZGF0YSBsZW5ndGguIEV4cGVjdGVkICR7b3B0cy5zaXplLmpvaW4oJywnKX0gZ290ICR7YnVmZmVyLmxlbmd0aH1gKTtcbiAgfVxuICBpZiAoa2luZCAhPT0gJ2N0cmwnKSB7XG4gICAgY29uc3QgaGVhZGVyID0gY3JlYXRlSGVhZGVyKGtpbmQsIDAsIGJ1ZmZlcik7XG4gICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbaGVhZGVyLCBidWZmZXIsIGhlYWRlcl0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNyYyA9IEJ1ZmZlci5hbGxvYygyKTtcbiAgICBjcmMud3JpdGVVSW50MTZMRShjcmMxNmNjaXR0KGJ1ZmZlciwgMHg1NUFBKSwgMCk7XG4gICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbYnVmZmVyLCBjcmNdKTtcbiAgfVxuICBjb25zdCBkZXN0ID0gb3B0cy5vZmZzZXQudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDQsICcwJyk7XG4gIGNvbnN0IGJhciA9IG5ldyBQcm9ncmVzcyhcbiAgICBgICBmbGFzaGluZyBbOmJhcl0gdG8gJHtkZXN0fSA6cmF0ZS9icHMgOnBlcmNlbnQgOmN1cnJlbnQvOnRvdGFsIDpldGFzYCxcbiAgICB7XG4gICAgICB0b3RhbDogYnVmZmVyLmxlbmd0aCxcbiAgICAgIHdpZHRoOiAzMCxcbiAgICB9LFxuICApO1xuICBkZXZpY2Uub24oJ2Rvd25sb2FkRGF0YScsICh7IGRvbWFpbjogZG93bmxvYWREb21haW4sIGxlbmd0aCB9KSA9PiB7XG4gICAgaWYgKGRvbWFpbiA9PT0gZG93bmxvYWREb21haW4pIGJhci50aWNrKGxlbmd0aCk7XG4gIH0pO1xuXG4gIGF3YWl0IGRldmljZS5kb3dubG9hZChkb21haW4sIGJ1ZmZlciwgb3B0cy5vZmZzZXQpO1xuICBkZXZpY2Uuc2VsZWN0b3IgPSAwO1xuICBhd2FpdCBkZXZpY2Uud3JpdGUoZGV2aWNlLmdldElkKCdzZWxlY3RvcicpKTtcbiAgY29uc3QgZGF0YSA9IGF3YWl0IGRldmljZS51cGxvYWQoJ01PRFVMJywgMCwgNik7XG4gIC8vIGNvbnNvbGUubG9nKCdSRVNVTFQnLCBkYXRhWzNdLnRvU3RyaW5nKDIpLCBkYXRhKTtcbiAgaWYgKGRhdGFbM10gJiAwYjEwMCkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ9Ce0YjQuNCx0LrQsCDQutC+0L3RgtGA0L7Qu9GM0L3QvtC5INGB0YPQvNC80Ysg0LIg0LrQsNC00YDQtScpO1xuICB9XG4gIGlmIChkYXRhWzNdICYgMGIxMDAwKSB7XG4gICAgY29uc29sZS5lcnJvcign0KLQsNC50LzQsNGD0YIg0L7QttC40LTQsNC90LjRjyDQstCw0LvQuNC00L3QvtGB0YLQuCDRgdGC0YDQsNC90LjRhtGLJyk7XG4gIH1cbiAgaWYgKGRhdGFbM10gJiAwYjEwMDAwKSB7XG4gICAgY29uc29sZS5lcnJvcign0J7RiNC40LHQutCwINCyINGA0LDQsdC+0YLQtSDRhNC70LXRiCDQv9Cw0LzRj9GC0LgnKTtcbiAgfVxuICBpZiAob3B0cy5leGVjKSB7XG4gICAgYXdhaXQgZGV2aWNlLmV4ZWN1dGUob3B0cy5leGVjKTtcbiAgfVxuICAvLyBjb25zb2xlLmxvZygnQlVGRkVSJywgYnVmZmVyLnNsaWNlKDAsIDgwKS50b1N0cmluZygnaGV4JykpO1xufVxuXG5jb25zdCBmbGFzaENvbW1hbmQ6IENvbW1hbmRNb2R1bGU8Q29tbW9uT3B0cywgRmxhc2hPcHRzPiA9IHtcbiAgY29tbWFuZDogJ2ZsYXNoJyxcbiAgZGVzY3JpYmU6ICfQv9GA0L7RiNC40LLQutCwINC80LjQvdC40YXQvtGB0YLQsDMnLFxuICBidWlsZGVyOiBhcmd2ID0+IGFyZ3ZcbiAgICAub3B0aW9uKCdraW5kJywge1xuICAgICAgYWxpYXM6ICdrJyxcbiAgICAgIGNob2ljZXM6IFsncmJmJywgJ3RjYScsICd0Y2MnLCAndHRjJywgJ2N0cmwnXSxcbiAgICB9KVxuICAgIC8vIC5vcHRpb24oJ29mZnNldCcsIHtcbiAgICAvLyAgIGFsaWFzOiAnb2ZzJyxcbiAgICAvLyAgIGRlZmF1bHQ6IDAsXG4gICAgLy8gICBudW1iZXI6IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9GB0LzQtdGJ0LXQvdC40LUg0LIg0LTQvtC80LXQvdC1JyxcbiAgICAvLyB9KVxuICAgIC5vcHRpb24oJ3NvdXJjZScsIHtcbiAgICAgIGFsaWFzOiAnc3JjJyxcbiAgICAgIHN0cmluZzogdHJ1ZSxcbiAgICAgIGRlc2NyaWJlOiAn0LfQsNCz0YDRg9C30LjRgtGMINC00LDQvdC90YvQtSDQuNC3INGE0LDQudC70LAnLFxuICAgIH0pXG4gICAgLy8gLm9wdGlvbignZXhlY3V0ZScsIHtcbiAgICAvLyAgIGFsaWFzOiAnZXhlYycsXG4gICAgLy8gICBzdHJpbmc6IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9Cy0YvQv9C+0LvQvdC40YLRjCDQv9GA0L7Qs9GA0LDQvNC80YMg0L/QvtGB0LvQtSDQt9Cw0L/QuNGB0LgnLFxuICAgIC8vIH0pXG4gICAgLy8gLm9wdGlvbignaGV4Jywge1xuICAgIC8vICAgYm9vbGVhbjogdHJ1ZSxcbiAgICAvLyAgIGRlc2NyaWJlOiAn0LjRgdC/0L7Qu9GM0LfQvtCy0LDRgtGMINGI0LXRgdGC0L3QsNC00YbQsNGC0LjRgNC40YfQvdGL0Lkg0YTQvtGA0LzQsNGCJyxcbiAgICAvLyB9KVxuICAgIC8vIC5vcHRpb24oJ2RlYycsIHtcbiAgICAvLyAgIGJvb2xlYW46IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9C40YHQv9C+0LvRjNC30L7QstCw0YLRjCDQtNC10YHRj9GC0LjRh9C90YvQuSDQtNCy0YPQsdCw0LnRgtC90YvQuSDRhNC+0YDQvNCw0YInLFxuICAgIC8vIH0pXG4gICAgLy8gLmNvbmZsaWN0cygnaGV4JywgJ2RlYycpXG4gICAgLmV4YW1wbGUoXG4gICAgICAnJDAgZmxhc2ggLW0gOjoxIC1rIHJiZiBtb2R1bGVTZWxlY3Q9MCAtLXNyYyBBbHBoYV9DdHJsX1NQSV9Nb2R1bGVfQzEwXzMyMF8xMDQucmJmJyxcbiAgICAgICfQn9GA0L7RiNC40LLQutCwINCf0JvQmNChICjQtdGB0LvQuCDRgNCw0YHRiNC40YDQtdC90LjQtSAucmJmLCBbLWsgcmJmXSAtINC80L7QttC90L4g0L3QtSDRg9C60LDQt9GL0LLQsNGC0YwpICcsXG4gICAgKVxuICAgIC5leGFtcGxlKFxuICAgICAgJyQwIGZsYXNoIC1tIDo6MSAtayB0Y2MgbW9kdWxlU2VsZWN0PTAgLS1zcmMgZGF0YS50Y2MnLFxuICAgICAgJ9Cf0YDQvtGI0LjQstC60LAg0YLQsNCx0LvQuNGG0Ysg0YbQstC10YLQvtC60L7RgNGA0LXQutGG0LjQuCB2MSAo0LXRgdC70Lgg0YDQsNGB0YjQuNGA0LXQvdC40LUgLnRjYywgWy1rIHRjY10gLSDQvNC+0LbQvdC+INC90LUg0YPQutCw0LfRi9Cy0LDRgtGMKScsXG4gICAgKVxuICAgIC5leGFtcGxlKFxuICAgICAgJyQwIGZsYXNoIC1tIDo6MSAtayB0dGMgbW9kdWxlU2VsZWN0PTAgLS1zcmMgY29uZmlnLnhtbCcsXG4gICAgICAn0J/RgNC+0YjQuNCy0LrQsCDRgtCw0LHQu9C40YbRiyDRhtCy0LXRgtC+0LrQvtGA0YDQtdC60YbQuNC4IHYyICjQtdGB0LvQuCDRgNCw0YHRiNC40YDQtdC90LjQtSAueG1sLCBbLWsgdHRjXSAtINC80L7QttC90L4g0L3QtSDRg9C60LDQt9GL0LLQsNGC0YwpJyxcbiAgICApXG4gICAgLmV4YW1wbGUoXG4gICAgICAnJDAgZmxhc2ggLW0gOjoxIC1rIGN0cmwgbW9kdWxlU2VsZWN0PTAgLS1zcmMgU2xpbV9DdHJsX3Y1X01jdV92MS4yLnR4dCcsXG4gICAgICAn0J/RgNC+0YjQuNCy0LrQsCDQv9GA0L7RhtC10YHRgdC+0YDQsCAo0LXRgdC70Lgg0YDQsNGB0YjQuNGA0LXQvdC40LUgLnR4dCwgWy1rIGN0cmxdIC0g0LzQvtC20L3QviDQvdC1INGD0LrQsNC30YvQstCw0YLRjCknLFxuICAgIClcbiAgICAuZGVtYW5kT3B0aW9uKFsnbWFjJywgJ20nLCAnc291cmNlJ10pLFxuICBoYW5kbGVyOiBtYWtlQWRkcmVzc0hhbmRsZXIoYWN0aW9uKSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZsYXNoQ29tbWFuZDtcbiJdfQ==