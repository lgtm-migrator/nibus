"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.action = action;
exports.default = exports.convert = void 0;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _progress = _interopRequireDefault(require("progress"));

var _handlers = require("../handlers");

var _write = require("./write");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function readAllFromStdin() {
  const buffers = []; // let rest = max;

  const onData = buffer => {
    // if (rest <= 0) return;
    buffers.push(buffer); // rest -= buffer.length;
  };

  return new Promise((resolve, reject) => {
    process.stdin.on('data', onData).once('end', () => {
      process.stdin.off('data', onData);
      process.stdin.off('error', reject);
      resolve(Buffer.concat(buffers));
    }).once('error', reject);
  });
}

const convert = buffer => {
  const lines = buffer.toString('ascii').split(/\r?\n/g);
  let offset = 0;
  if (lines.length === 0) return [Buffer.alloc(0), 0];
  const first = lines[0];
  let start = 0;

  if (first[0] === '@') {
    offset = parseInt(first.slice(1), 16);
    start = 1;
  }

  const hexToBuf = hex => Buffer.from(hex.split(/[\s:-=]/g).join(''), 'hex');

  return [Buffer.concat(lines.slice(start).map(hexToBuf)), offset];
};

exports.convert = convert;

async function action(device, args) {
  const {
    domain,
    offset,
    source,
    hex
  } = args;
  await (0, _write.action)(device, args);
  let buffer;
  let ofs = 0;

  let tick = size => {};

  if (source) {
    buffer = await _fs.default.promises.readFile(source);
    if (hex) [buffer, ofs] = convert(buffer);
    const dest = (offset || ofs).toString(16).padStart(4, '0');
    const bar = new _progress.default(`  downloading [:bar] to ${dest} :rate/bps :percent :current/:total :etas`, {
      total: buffer.length,
      width: 20
    });
    tick = bar.tick.bind(bar);
  } else {
    buffer = await readAllFromStdin();

    if (hex) {
      [buffer, ofs] = convert(buffer);
    }
  }

  device.on('downloadData', ({
    domain: dataDomain,
    length
  }) => {
    if (dataDomain === domain) tick(length);
  });
  await device.download(domain, buffer, offset || ofs, !args.terminate);
}

const downloadCommand = {
  command: 'download',
  describe: 'загрузить домен в устройство',
  builder: argv => argv.option('domain', {
    default: 'CODE',
    describe: 'имя домена',
    string: true
  }).option('offset', {
    alias: 'ofs',
    default: 0,
    number: true,
    describe: 'смещение в домене'
  }).option('source', {
    alias: 'src',
    string: true,
    describe: 'загрузить данные из файла'
  }).option('hex', {
    boolean: true,
    describe: 'использовать текстовый формат'
  }).check(({
    hex,
    raw
  }) => {
    if (hex && raw) throw new Error('Arguments hex and raw are mutually exclusive');
    return true;
  }).option('execute', {
    alias: 'exec',
    string: true,
    describe: 'выполнить программу после записи'
  }).option('term', {
    alias: 'terminate',
    describe: 'выполнять TerminateDownloadSequence в конце',
    boolean: true,
    default: true
  }).demandOption(['m', 'mac']),
  handler: (0, _handlers.makeAddressHandler)(action, true)
};
var _default = downloadCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZG93bmxvYWQudHMiXSwibmFtZXMiOlsicmVhZEFsbEZyb21TdGRpbiIsImJ1ZmZlcnMiLCJvbkRhdGEiLCJidWZmZXIiLCJwdXNoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9jZXNzIiwic3RkaW4iLCJvbiIsIm9uY2UiLCJvZmYiLCJCdWZmZXIiLCJjb25jYXQiLCJjb252ZXJ0IiwibGluZXMiLCJ0b1N0cmluZyIsInNwbGl0Iiwib2Zmc2V0IiwibGVuZ3RoIiwiYWxsb2MiLCJmaXJzdCIsInN0YXJ0IiwicGFyc2VJbnQiLCJzbGljZSIsImhleFRvQnVmIiwiaGV4IiwiZnJvbSIsImpvaW4iLCJtYXAiLCJhY3Rpb24iLCJkZXZpY2UiLCJhcmdzIiwiZG9tYWluIiwic291cmNlIiwib2ZzIiwidGljayIsInNpemUiLCJmcyIsInByb21pc2VzIiwicmVhZEZpbGUiLCJkZXN0IiwicGFkU3RhcnQiLCJiYXIiLCJQcm9ncmVzcyIsInRvdGFsIiwid2lkdGgiLCJiaW5kIiwiZGF0YURvbWFpbiIsImRvd25sb2FkIiwidGVybWluYXRlIiwiZG93bmxvYWRDb21tYW5kIiwiY29tbWFuZCIsImRlc2NyaWJlIiwiYnVpbGRlciIsImFyZ3YiLCJvcHRpb24iLCJkZWZhdWx0Iiwic3RyaW5nIiwiYWxpYXMiLCJudW1iZXIiLCJib29sZWFuIiwiY2hlY2siLCJyYXciLCJFcnJvciIsImRlbWFuZE9wdGlvbiIsImhhbmRsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFXQTs7QUFDQTs7QUFHQTs7QUFFQTs7OztBQVlBLFNBQVNBLGdCQUFULEdBQTRCO0FBQzFCLFFBQU1DLE9BQWlCLEdBQUcsRUFBMUIsQ0FEMEIsQ0FFMUI7O0FBQ0EsUUFBTUMsTUFBTSxHQUFJQyxNQUFELElBQW9CO0FBQ2pDO0FBQ0FGLElBQUFBLE9BQU8sQ0FBQ0csSUFBUixDQUFhRCxNQUFiLEVBRmlDLENBR2pDO0FBQ0QsR0FKRDs7QUFLQSxTQUFPLElBQUlFLE9BQUosQ0FBcUIsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQy9DQyxJQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FDR0MsRUFESCxDQUNNLE1BRE4sRUFDY1IsTUFEZCxFQUVHUyxJQUZILENBRVEsS0FGUixFQUVlLE1BQU07QUFDakJILE1BQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjRyxHQUFkLENBQWtCLE1BQWxCLEVBQTBCVixNQUExQjtBQUNBTSxNQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0csR0FBZCxDQUFrQixPQUFsQixFQUEyQkwsTUFBM0I7QUFDQUQsTUFBQUEsT0FBTyxDQUFDTyxNQUFNLENBQUNDLE1BQVAsQ0FBY2IsT0FBZCxDQUFELENBQVA7QUFDRCxLQU5ILEVBT0dVLElBUEgsQ0FPUSxPQVBSLEVBT2lCSixNQVBqQjtBQVFELEdBVE0sQ0FBUDtBQVVEOztBQUVNLE1BQU1RLE9BQU8sR0FBSVosTUFBRCxJQUFzQztBQUMzRCxRQUFNYSxLQUFLLEdBQUdiLE1BQU0sQ0FBQ2MsUUFBUCxDQUFnQixPQUFoQixFQUF5QkMsS0FBekIsQ0FBK0IsUUFBL0IsQ0FBZDtBQUNBLE1BQUlDLE1BQU0sR0FBRyxDQUFiO0FBQ0EsTUFBSUgsS0FBSyxDQUFDSSxNQUFOLEtBQWlCLENBQXJCLEVBQXdCLE9BQU8sQ0FBQ1AsTUFBTSxDQUFDUSxLQUFQLENBQWEsQ0FBYixDQUFELEVBQWtCLENBQWxCLENBQVA7QUFDeEIsUUFBTUMsS0FBSyxHQUFHTixLQUFLLENBQUMsQ0FBRCxDQUFuQjtBQUNBLE1BQUlPLEtBQUssR0FBRyxDQUFaOztBQUNBLE1BQUlELEtBQUssQ0FBQyxDQUFELENBQUwsS0FBYSxHQUFqQixFQUFzQjtBQUNwQkgsSUFBQUEsTUFBTSxHQUFHSyxRQUFRLENBQUNGLEtBQUssQ0FBQ0csS0FBTixDQUFZLENBQVosQ0FBRCxFQUFpQixFQUFqQixDQUFqQjtBQUNBRixJQUFBQSxLQUFLLEdBQUcsQ0FBUjtBQUNEOztBQUNELFFBQU1HLFFBQVEsR0FBSUMsR0FBRCxJQUFpQmQsTUFBTSxDQUFDZSxJQUFQLENBQVlELEdBQUcsQ0FBQ1QsS0FBSixDQUFVLFVBQVYsRUFBc0JXLElBQXRCLENBQTJCLEVBQTNCLENBQVosRUFBNEMsS0FBNUMsQ0FBbEM7O0FBQ0EsU0FBTyxDQUFDaEIsTUFBTSxDQUFDQyxNQUFQLENBQWNFLEtBQUssQ0FBQ1MsS0FBTixDQUFZRixLQUFaLEVBQW1CTyxHQUFuQixDQUF1QkosUUFBdkIsQ0FBZCxDQUFELEVBQWtEUCxNQUFsRCxDQUFQO0FBQ0QsQ0FaTTs7OztBQWNBLGVBQWVZLE1BQWYsQ0FDTEMsTUFESyxFQUVMQyxJQUZLLEVBRTBCO0FBQy9CLFFBQU07QUFBRUMsSUFBQUEsTUFBRjtBQUFVZixJQUFBQSxNQUFWO0FBQWtCZ0IsSUFBQUEsTUFBbEI7QUFBMEJSLElBQUFBO0FBQTFCLE1BQWtDTSxJQUF4QztBQUNBLFFBQU0sbUJBQVlELE1BQVosRUFBb0JDLElBQXBCLENBQU47QUFDQSxNQUFJOUIsTUFBSjtBQUNBLE1BQUlpQyxHQUFHLEdBQUcsQ0FBVjs7QUFDQSxNQUFJQyxJQUFJLEdBQUlDLElBQUQsSUFBa0IsQ0FBRSxDQUEvQjs7QUFDQSxNQUFJSCxNQUFKLEVBQVk7QUFDVmhDLElBQUFBLE1BQU0sR0FBRyxNQUFNb0MsWUFBR0MsUUFBSCxDQUFZQyxRQUFaLENBQXFCTixNQUFyQixDQUFmO0FBQ0EsUUFBSVIsR0FBSixFQUFTLENBQUN4QixNQUFELEVBQVNpQyxHQUFULElBQWdCckIsT0FBTyxDQUFDWixNQUFELENBQXZCO0FBQ1QsVUFBTXVDLElBQUksR0FBRyxDQUFDdkIsTUFBTSxJQUFJaUIsR0FBWCxFQUFnQm5CLFFBQWhCLENBQXlCLEVBQXpCLEVBQTZCMEIsUUFBN0IsQ0FBc0MsQ0FBdEMsRUFBeUMsR0FBekMsQ0FBYjtBQUNBLFVBQU1DLEdBQUcsR0FBRyxJQUFJQyxpQkFBSixDQUNULDJCQUEwQkgsSUFBSywyQ0FEdEIsRUFFVjtBQUNFSSxNQUFBQSxLQUFLLEVBQUUzQyxNQUFNLENBQUNpQixNQURoQjtBQUVFMkIsTUFBQUEsS0FBSyxFQUFFO0FBRlQsS0FGVSxDQUFaO0FBT0FWLElBQUFBLElBQUksR0FBR08sR0FBRyxDQUFDUCxJQUFKLENBQVNXLElBQVQsQ0FBY0osR0FBZCxDQUFQO0FBQ0QsR0FaRCxNQVlPO0FBQ0x6QyxJQUFBQSxNQUFNLEdBQUcsTUFBTUgsZ0JBQWdCLEVBQS9COztBQUNBLFFBQUkyQixHQUFKLEVBQVM7QUFDUCxPQUFDeEIsTUFBRCxFQUFTaUMsR0FBVCxJQUFnQnJCLE9BQU8sQ0FBQ1osTUFBRCxDQUF2QjtBQUNEO0FBQ0Y7O0FBQ0Q2QixFQUFBQSxNQUFNLENBQUN0QixFQUFQLENBQVUsY0FBVixFQUEwQixDQUFDO0FBQUV3QixJQUFBQSxNQUFNLEVBQUVlLFVBQVY7QUFBc0I3QixJQUFBQTtBQUF0QixHQUFELEtBQW9DO0FBQzVELFFBQUk2QixVQUFVLEtBQUtmLE1BQW5CLEVBQTJCRyxJQUFJLENBQUNqQixNQUFELENBQUo7QUFDNUIsR0FGRDtBQUlBLFFBQU1ZLE1BQU0sQ0FBQ2tCLFFBQVAsQ0FBZ0JoQixNQUFoQixFQUF3Qi9CLE1BQXhCLEVBQWdDZ0IsTUFBTSxJQUFJaUIsR0FBMUMsRUFBK0MsQ0FBQ0gsSUFBSSxDQUFDa0IsU0FBckQsQ0FBTjtBQUNEOztBQUVELE1BQU1DLGVBQXdELEdBQUc7QUFDL0RDLEVBQUFBLE9BQU8sRUFBRSxVQURzRDtBQUUvREMsRUFBQUEsUUFBUSxFQUFFLDhCQUZxRDtBQUcvREMsRUFBQUEsT0FBTyxFQUFFQyxJQUFJLElBQ1hBLElBQUksQ0FDREMsTUFESCxDQUNVLFFBRFYsRUFDb0I7QUFDaEJDLElBQUFBLE9BQU8sRUFBRSxNQURPO0FBRWhCSixJQUFBQSxRQUFRLEVBQUUsWUFGTTtBQUdoQkssSUFBQUEsTUFBTSxFQUFFO0FBSFEsR0FEcEIsRUFNR0YsTUFOSCxDQU1VLFFBTlYsRUFNb0I7QUFDaEJHLElBQUFBLEtBQUssRUFBRSxLQURTO0FBRWhCRixJQUFBQSxPQUFPLEVBQUUsQ0FGTztBQUdoQkcsSUFBQUEsTUFBTSxFQUFFLElBSFE7QUFJaEJQLElBQUFBLFFBQVEsRUFBRTtBQUpNLEdBTnBCLEVBWUdHLE1BWkgsQ0FZVSxRQVpWLEVBWW9CO0FBQ2hCRyxJQUFBQSxLQUFLLEVBQUUsS0FEUztBQUVoQkQsSUFBQUEsTUFBTSxFQUFFLElBRlE7QUFHaEJMLElBQUFBLFFBQVEsRUFBRTtBQUhNLEdBWnBCLEVBaUJHRyxNQWpCSCxDQWlCVSxLQWpCVixFQWlCaUI7QUFDYkssSUFBQUEsT0FBTyxFQUFFLElBREk7QUFFYlIsSUFBQUEsUUFBUSxFQUFFO0FBRkcsR0FqQmpCLEVBcUJHUyxLQXJCSCxDQXFCUyxDQUFDO0FBQUVwQyxJQUFBQSxHQUFGO0FBQU9xQyxJQUFBQTtBQUFQLEdBQUQsS0FBa0I7QUFDdkIsUUFBSXJDLEdBQUcsSUFBSXFDLEdBQVgsRUFBZ0IsTUFBTSxJQUFJQyxLQUFKLENBQVUsOENBQVYsQ0FBTjtBQUNoQixXQUFPLElBQVA7QUFDRCxHQXhCSCxFQXlCR1IsTUF6QkgsQ0F5QlUsU0F6QlYsRUF5QnFCO0FBQ2pCRyxJQUFBQSxLQUFLLEVBQUUsTUFEVTtBQUVqQkQsSUFBQUEsTUFBTSxFQUFFLElBRlM7QUFHakJMLElBQUFBLFFBQVEsRUFBRTtBQUhPLEdBekJyQixFQThCR0csTUE5QkgsQ0E4QlUsTUE5QlYsRUE4QmtCO0FBQ2RHLElBQUFBLEtBQUssRUFBRSxXQURPO0FBRWROLElBQUFBLFFBQVEsRUFBRSw2Q0FGSTtBQUdkUSxJQUFBQSxPQUFPLEVBQUUsSUFISztBQUlkSixJQUFBQSxPQUFPLEVBQUU7QUFKSyxHQTlCbEIsRUFvQ0dRLFlBcENILENBb0NnQixDQUFDLEdBQUQsRUFBTSxLQUFOLENBcENoQixDQUo2RDtBQXlDL0RDLEVBQUFBLE9BQU8sRUFBRSxrQ0FBbUJwQyxNQUFuQixFQUEyQixJQUEzQjtBQXpDc0QsQ0FBakU7ZUE0Q2VxQixlIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCB7IEFyZ3VtZW50cywgQ29tbWFuZE1vZHVsZSwgRGVmaW5lZCB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgUHJvZ3Jlc3MgZnJvbSAncHJvZ3Jlc3MnO1xuXG5pbXBvcnQgeyBJRGV2aWNlIH0gZnJvbSAnQG5pYnVzL2NvcmUvbGliL21pYic7XG5pbXBvcnQgeyBtYWtlQWRkcmVzc0hhbmRsZXIgfSBmcm9tICcuLi9oYW5kbGVycyc7XG5pbXBvcnQgeyBDb21tb25PcHRzIH0gZnJvbSAnLi4vb3B0aW9ucyc7XG5pbXBvcnQgeyBhY3Rpb24gYXMgd3JpdGVBY3Rpb24gfSBmcm9tICcuL3dyaXRlJztcblxudHlwZSBEb3dubG9hZE9wdHMgPSBEZWZpbmVkPENvbW1vbk9wdHMsICdtJyB8ICdtYWMnPiAmIHtcbiAgZG9tYWluOiBzdHJpbmcsXG4gIG9mZnNldDogbnVtYmVyLFxuICBzb3VyY2U/OiBzdHJpbmcsXG4gIHNyYz86IHN0cmluZyxcbiAgaGV4PzogYm9vbGVhbixcbiAgZXhlY3V0ZT86IHN0cmluZyxcbiAgdGVybWluYXRlPzogYm9vbGVhbixcbn07XG5cbmZ1bmN0aW9uIHJlYWRBbGxGcm9tU3RkaW4oKSB7XG4gIGNvbnN0IGJ1ZmZlcnM6IEJ1ZmZlcltdID0gW107XG4gIC8vIGxldCByZXN0ID0gbWF4O1xuICBjb25zdCBvbkRhdGEgPSAoYnVmZmVyOiBCdWZmZXIpID0+IHtcbiAgICAvLyBpZiAocmVzdCA8PSAwKSByZXR1cm47XG4gICAgYnVmZmVycy5wdXNoKGJ1ZmZlcik7XG4gICAgLy8gcmVzdCAtPSBidWZmZXIubGVuZ3RoO1xuICB9O1xuICByZXR1cm4gbmV3IFByb21pc2U8QnVmZmVyPigoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHByb2Nlc3Muc3RkaW5cbiAgICAgIC5vbignZGF0YScsIG9uRGF0YSlcbiAgICAgIC5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub2ZmKCdkYXRhJywgb25EYXRhKTtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vZmYoJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgcmVzb2x2ZShCdWZmZXIuY29uY2F0KGJ1ZmZlcnMpKTtcbiAgICAgIH0pXG4gICAgICAub25jZSgnZXJyb3InLCByZWplY3QpO1xuICB9KSk7XG59XG5cbmV4cG9ydCBjb25zdCBjb252ZXJ0ID0gKGJ1ZmZlcjogQnVmZmVyKTogW0J1ZmZlciwgbnVtYmVyXSA9PiB7XG4gIGNvbnN0IGxpbmVzID0gYnVmZmVyLnRvU3RyaW5nKCdhc2NpaScpLnNwbGl0KC9cXHI/XFxuL2cpO1xuICBsZXQgb2Zmc2V0ID0gMDtcbiAgaWYgKGxpbmVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFtCdWZmZXIuYWxsb2MoMCksIDBdO1xuICBjb25zdCBmaXJzdCA9IGxpbmVzWzBdO1xuICBsZXQgc3RhcnQgPSAwO1xuICBpZiAoZmlyc3RbMF0gPT09ICdAJykge1xuICAgIG9mZnNldCA9IHBhcnNlSW50KGZpcnN0LnNsaWNlKDEpLCAxNik7XG4gICAgc3RhcnQgPSAxO1xuICB9XG4gIGNvbnN0IGhleFRvQnVmID0gKGhleDogc3RyaW5nKSA9PiBCdWZmZXIuZnJvbShoZXguc3BsaXQoL1tcXHM6LT1dL2cpLmpvaW4oJycpLCAnaGV4Jyk7XG4gIHJldHVybiBbQnVmZmVyLmNvbmNhdChsaW5lcy5zbGljZShzdGFydCkubWFwKGhleFRvQnVmKSksIG9mZnNldF07XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWN0aW9uKFxuICBkZXZpY2U6IElEZXZpY2UsXG4gIGFyZ3M6IEFyZ3VtZW50czxEb3dubG9hZE9wdHM+KSB7XG4gIGNvbnN0IHsgZG9tYWluLCBvZmZzZXQsIHNvdXJjZSwgaGV4IH0gPSBhcmdzO1xuICBhd2FpdCB3cml0ZUFjdGlvbihkZXZpY2UsIGFyZ3MpO1xuICBsZXQgYnVmZmVyOiBCdWZmZXI7XG4gIGxldCBvZnMgPSAwO1xuICBsZXQgdGljayA9IChzaXplOiBudW1iZXIpID0+IHt9O1xuICBpZiAoc291cmNlKSB7XG4gICAgYnVmZmVyID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoc291cmNlKTtcbiAgICBpZiAoaGV4KSBbYnVmZmVyLCBvZnNdID0gY29udmVydChidWZmZXIpO1xuICAgIGNvbnN0IGRlc3QgPSAob2Zmc2V0IHx8IG9mcykudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDQsICcwJyk7XG4gICAgY29uc3QgYmFyID0gbmV3IFByb2dyZXNzKFxuICAgICAgYCAgZG93bmxvYWRpbmcgWzpiYXJdIHRvICR7ZGVzdH0gOnJhdGUvYnBzIDpwZXJjZW50IDpjdXJyZW50Lzp0b3RhbCA6ZXRhc2AsXG4gICAgICB7XG4gICAgICAgIHRvdGFsOiBidWZmZXIubGVuZ3RoLFxuICAgICAgICB3aWR0aDogMjAsXG4gICAgICB9LFxuICAgICk7XG4gICAgdGljayA9IGJhci50aWNrLmJpbmQoYmFyKTtcbiAgfSBlbHNlIHtcbiAgICBidWZmZXIgPSBhd2FpdCByZWFkQWxsRnJvbVN0ZGluKCk7XG4gICAgaWYgKGhleCkge1xuICAgICAgW2J1ZmZlciwgb2ZzXSA9IGNvbnZlcnQoYnVmZmVyKTtcbiAgICB9XG4gIH1cbiAgZGV2aWNlLm9uKCdkb3dubG9hZERhdGEnLCAoeyBkb21haW46IGRhdGFEb21haW4sIGxlbmd0aCB9KSA9PiB7XG4gICAgaWYgKGRhdGFEb21haW4gPT09IGRvbWFpbikgdGljayhsZW5ndGgpO1xuICB9KTtcblxuICBhd2FpdCBkZXZpY2UuZG93bmxvYWQoZG9tYWluLCBidWZmZXIsIG9mZnNldCB8fCBvZnMsICFhcmdzLnRlcm1pbmF0ZSk7XG59XG5cbmNvbnN0IGRvd25sb2FkQ29tbWFuZDogQ29tbWFuZE1vZHVsZTxDb21tb25PcHRzLCBEb3dubG9hZE9wdHM+ID0ge1xuICBjb21tYW5kOiAnZG93bmxvYWQnLFxuICBkZXNjcmliZTogJ9C30LDQs9GA0YPQt9C40YLRjCDQtNC+0LzQtdC9INCyINGD0YHRgtGA0L7QudGB0YLQstC+JyxcbiAgYnVpbGRlcjogYXJndiA9PlxuICAgIGFyZ3ZcbiAgICAgIC5vcHRpb24oJ2RvbWFpbicsIHtcbiAgICAgICAgZGVmYXVsdDogJ0NPREUnLFxuICAgICAgICBkZXNjcmliZTogJ9C40LzRjyDQtNC+0LzQtdC90LAnLFxuICAgICAgICBzdHJpbmc6IHRydWUsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignb2Zmc2V0Jywge1xuICAgICAgICBhbGlhczogJ29mcycsXG4gICAgICAgIGRlZmF1bHQ6IDAsXG4gICAgICAgIG51bWJlcjogdHJ1ZSxcbiAgICAgICAgZGVzY3JpYmU6ICfRgdC80LXRidC10L3QuNC1INCyINC00L7QvNC10L3QtScsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignc291cmNlJywge1xuICAgICAgICBhbGlhczogJ3NyYycsXG4gICAgICAgIHN0cmluZzogdHJ1ZSxcbiAgICAgICAgZGVzY3JpYmU6ICfQt9Cw0LPRgNGD0LfQuNGC0Ywg0LTQsNC90L3Ri9C1INC40Lcg0YTQsNC50LvQsCcsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignaGV4Jywge1xuICAgICAgICBib29sZWFuOiB0cnVlLFxuICAgICAgICBkZXNjcmliZTogJ9C40YHQv9C+0LvRjNC30L7QstCw0YLRjCDRgtC10LrRgdGC0L7QstGL0Lkg0YTQvtGA0LzQsNGCJyxcbiAgICAgIH0pXG4gICAgICAuY2hlY2soKHsgaGV4LCByYXcgfSkgPT4ge1xuICAgICAgICBpZiAoaGV4ICYmIHJhdykgdGhyb3cgbmV3IEVycm9yKCdBcmd1bWVudHMgaGV4IGFuZCByYXcgYXJlIG11dHVhbGx5IGV4Y2x1c2l2ZScpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdleGVjdXRlJywge1xuICAgICAgICBhbGlhczogJ2V4ZWMnLFxuICAgICAgICBzdHJpbmc6IHRydWUsXG4gICAgICAgIGRlc2NyaWJlOiAn0LLRi9C/0L7Qu9C90LjRgtGMINC/0YDQvtCz0YDQsNC80LzRgyDQv9C+0YHQu9C1INC30LDQv9C40YHQuCcsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbigndGVybScsIHtcbiAgICAgICAgYWxpYXM6ICd0ZXJtaW5hdGUnLFxuICAgICAgICBkZXNjcmliZTogJ9Cy0YvQv9C+0LvQvdGP0YLRjCBUZXJtaW5hdGVEb3dubG9hZFNlcXVlbmNlINCyINC60L7QvdGG0LUnLFxuICAgICAgICBib29sZWFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0OiB0cnVlLFxuICAgICAgfSlcbiAgICAgIC5kZW1hbmRPcHRpb24oWydtJywgJ21hYyddKSxcbiAgaGFuZGxlcjogbWFrZUFkZHJlc3NIYW5kbGVyKGFjdGlvbiwgdHJ1ZSksXG59O1xuXG5leHBvcnQgZGVmYXVsdCBkb3dubG9hZENvbW1hbmQ7XG4iXX0=