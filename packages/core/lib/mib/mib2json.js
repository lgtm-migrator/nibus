"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.mib2json = mib2json;
exports.convert = convert;
exports.convertDir = convertDir;
exports.getMibs = getMibs;
exports.getMibsSync = getMibsSync;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _iconvLite = require("iconv-lite");

var path = _interopRequireWildcard(require("path"));

var _sax = _interopRequireDefault(require("sax"));

var _stream = require("stream");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
class Utf8Converter extends _stream.Transform {
  constructor(encoding) {
    super();
    this.encoding = encoding;

    if (!(0, _iconvLite.encodingExists)(encoding)) {
      throw new Error(`encoding ${encoding} is not supported`);
    }
  } // tslint:disable-next-line


  _transform(chunk, _encoding, callback) {
    callback(undefined, (0, _iconvLite.decode)(chunk, this.encoding));
  }

}

function getEncoding(mibpath) {
  return new Promise((resolve, reject) => {
    let encoding;

    const saxStream = _sax.default.createStream(true, {});

    saxStream.on('error', err => reject(err));
    saxStream.on('processinginstruction', pi => {
      if (!pi.body) {
        return;
      }

      const match = /encoding="(.*)"/g.exec(pi.body);

      if (match) {
        [, encoding] = match;
      }
    });
    saxStream.on('end', () => resolve(encoding));

    _fs.default.createReadStream(mibpath).pipe(saxStream);
  });
}

function mib2json(mibpath) {
  return new Promise((resolve, reject) => {
    const saxStream = _sax.default.createStream(true, {
      xmlns: true,
      trim: true,
      normalize: true
    });

    saxStream.on('error', err => reject(err));
    const root = {};
    let level = 0;
    let current;
    const types = {};
    let subroutines;
    const trail = [];
    let state;
    saxStream.on('opentag', tag => {
      //      logger.element(util.inspect(tag, {depth: null}));
      if (level < 5 || subroutines) {
        switch (tag.local) {
          case 'element':
            if (level === 1) {
              root[tag.attributes.name.value] = tag.attributes.type.value;
            } else if (subroutines) {
              current = subroutines[tag.attributes.name.value] = {};
            }

            break;

          case 'simpleType':
          case 'complexType':
            if (level === 1) {
              current = types[tag.attributes.name.value] = {};
              trail.length = 0;
            }

            break;

          case 'sequence':
            if (level === 2) {
              trail.push(current);
              current = false;
              root.subroutines = subroutines = {};
            }

            break;

          case 'annotation':
            state = 'annotation';
            break;

          case 'appinfo':
            current.appinfo = {};
            state = 'appinfo';
            break;

          case 'restriction':
            current.base = tag.attributes.base.value;
            break;

          case 'minInclusive':
          case 'maxInclusive':
          case 'minExclusive':
          case 'maxExclusive':
            current[tag.local] = tag.attributes.value.value;
            break;

          case 'enumeration':
            current.enumeration = current.enumeration || {};
            trail.push(current);
            current = current.enumeration[tag.attributes.value.value] = {};
            break;

          case 'attribute':
            current.properties = current.properties || {};
            trail.push(current);
            current = current.properties[tag.attributes.name.value] = {
              type: tag.attributes.type.value
            };
            break;
        }
      }

      level += 1;
    });
    saxStream.on('closetag', tagName => {
      level -= 1;

      if (tagName === 'xs:sequence') {
        subroutines = false;
        current = trail.pop();
      } else if (current) {
        if (tagName === 'xs:attribute' || tagName === 'xs:enumeration') {
          current = trail.pop();
        }
      }
    });

    const textHandler = function (text) {
      if (current) {
        if (state === 'appinfo') {
          const local = this._parser.tag.local;
          const appinfo = current.appinfo;

          if (appinfo[local]) {
            appinfo[local] += `
${text}`;
          } else {
            appinfo[local] = text;
          }
        }

        state === 'annotation' && (current.annotation = text);
      }
    };

    saxStream.on('text', textHandler);
    saxStream.on('end', () => {
      root.types = types;
      resolve(root);
    });
    getEncoding(mibpath).then(encoding => {
      let input = _fs.default.createReadStream(mibpath);

      if (encoding && (0, _iconvLite.encodingExists)(encoding)) {
        input = input.pipe(new Utf8Converter(encoding));
      }

      input.pipe(saxStream);
    }).catch(reject);
  });
}

async function convert(mibpath, dir) {
  const json = await mib2json(mibpath);
  let jsonpath = `${mibpath.replace(/\.[^/.]+$/, '')}.json`;

  if (dir) {
    jsonpath = path.resolve(dir, path.basename(jsonpath));
  }

  const data = JSON.stringify(json, null, 2);
  return new Promise((resolve, reject) => {
    _fs.default.writeFile(jsonpath, data, err => {
      if (err) {
        reject(err);
      } else {
        resolve(jsonpath);
      }
    });
  });
}

const xsdMibRe = /^\S+\.mib\.xsd$/i;
const jsonMibRe = /^(\S+)\.mib\.json$/i;

function convertDir(dir) {
  return new Promise((resolve, reject) => {
    _fs.default.readdir(dir, (err, files) => {
      if (err) {
        return reject(err);
      }

      const promises = files.filter(file => xsdMibRe.test(file)).map(file => convert(path.join(dir, file)).then(() => console.info(`${file}: success`)).catch(error => console.error(`${file}: ${error.message}`)));
      resolve(Promise.all(promises).then(() => void 0));
    });
  });
}

let mibs = [];
const mibsDir = path.resolve(__dirname, '../../mibs');

function filesToMibs(files) {
  return files.map(file => jsonMibRe.exec(file)).filter(matches => matches != null).map(matches => matches[1]);
}

function getMibs() {
  return new Promise((resolve, reject) => {
    _fs.default.readdir(mibsDir, (err, files) => {
      if (err) {
        mibs = [];
        return reject(err);
      }

      mibs = filesToMibs(files);
      resolve(mibs);
    });
  });
}

function getMibsSync() {
  if (!mibs || mibs.length === 0) {
    mibs = filesToMibs(_fs.default.readdirSync(mibsDir));
  }

  return mibs;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWIvbWliMmpzb24udHMiXSwibmFtZXMiOlsiVXRmOENvbnZlcnRlciIsIlRyYW5zZm9ybSIsImNvbnN0cnVjdG9yIiwiZW5jb2RpbmciLCJFcnJvciIsIl90cmFuc2Zvcm0iLCJjaHVuayIsIl9lbmNvZGluZyIsImNhbGxiYWNrIiwidW5kZWZpbmVkIiwiZ2V0RW5jb2RpbmciLCJtaWJwYXRoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzYXhTdHJlYW0iLCJzYXgiLCJjcmVhdGVTdHJlYW0iLCJvbiIsImVyciIsInBpIiwiYm9keSIsIm1hdGNoIiwiZXhlYyIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBpcGUiLCJtaWIyanNvbiIsInhtbG5zIiwidHJpbSIsIm5vcm1hbGl6ZSIsInJvb3QiLCJsZXZlbCIsImN1cnJlbnQiLCJ0eXBlcyIsInN1YnJvdXRpbmVzIiwidHJhaWwiLCJzdGF0ZSIsInRhZyIsImxvY2FsIiwiYXR0cmlidXRlcyIsIm5hbWUiLCJ2YWx1ZSIsInR5cGUiLCJsZW5ndGgiLCJwdXNoIiwiYXBwaW5mbyIsImJhc2UiLCJlbnVtZXJhdGlvbiIsInByb3BlcnRpZXMiLCJ0YWdOYW1lIiwicG9wIiwidGV4dEhhbmRsZXIiLCJ0ZXh0IiwiX3BhcnNlciIsImFubm90YXRpb24iLCJ0aGVuIiwiaW5wdXQiLCJjYXRjaCIsImNvbnZlcnQiLCJkaXIiLCJqc29uIiwianNvbnBhdGgiLCJyZXBsYWNlIiwicGF0aCIsImJhc2VuYW1lIiwiZGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ3cml0ZUZpbGUiLCJ4c2RNaWJSZSIsImpzb25NaWJSZSIsImNvbnZlcnREaXIiLCJyZWFkZGlyIiwiZmlsZXMiLCJwcm9taXNlcyIsImZpbHRlciIsImZpbGUiLCJ0ZXN0IiwibWFwIiwiam9pbiIsImNvbnNvbGUiLCJpbmZvIiwiZXJyb3IiLCJtZXNzYWdlIiwiYWxsIiwibWlicyIsIm1pYnNEaXIiLCJfX2Rpcm5hbWUiLCJmaWxlc1RvTWlicyIsIm1hdGNoZXMiLCJnZXRNaWJzIiwiZ2V0TWlic1N5bmMiLCJyZWFkZGlyU3luYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQVVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFkQTs7Ozs7Ozs7O0FBa0JBLE1BQU1BLGFBQU4sU0FBNEJDLGlCQUE1QixDQUFzQztBQUNwQ0MsRUFBQUEsV0FBVyxDQUFRQyxRQUFSLEVBQTBCO0FBQ25DO0FBRG1DLFNBQWxCQSxRQUFrQixHQUFsQkEsUUFBa0I7O0FBRW5DLFFBQUksQ0FBQywrQkFBZUEsUUFBZixDQUFMLEVBQStCO0FBQzdCLFlBQU0sSUFBSUMsS0FBSixDQUFXLFlBQVdELFFBQVMsbUJBQS9CLENBQU47QUFDRDtBQUNGLEdBTm1DLENBUXBDOzs7QUFDT0UsRUFBQUEsVUFBUCxDQUFrQkMsS0FBbEIsRUFBOEJDLFNBQTlCLEVBQWlEQyxRQUFqRCxFQUFvRjtBQUNsRkEsSUFBQUEsUUFBUSxDQUFDQyxTQUFELEVBQVksdUJBQU9ILEtBQVAsRUFBYyxLQUFLSCxRQUFuQixDQUFaLENBQVI7QUFDRDs7QUFYbUM7O0FBY3RDLFNBQVNPLFdBQVQsQ0FBcUJDLE9BQXJCLEVBQXVEO0FBQ3JELFNBQU8sSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0QyxRQUFJWCxRQUFKOztBQUNBLFVBQU1ZLFNBQVMsR0FBR0MsYUFBSUMsWUFBSixDQUFpQixJQUFqQixFQUF1QixFQUF2QixDQUFsQjs7QUFDQUYsSUFBQUEsU0FBUyxDQUFDRyxFQUFWLENBQWEsT0FBYixFQUFzQkMsR0FBRyxJQUFJTCxNQUFNLENBQUNLLEdBQUQsQ0FBbkM7QUFDQUosSUFBQUEsU0FBUyxDQUFDRyxFQUFWLENBQWEsdUJBQWIsRUFBdUNFLEVBQUQsSUFBUTtBQUM1QyxVQUFJLENBQUNBLEVBQUUsQ0FBQ0MsSUFBUixFQUFjO0FBQ1o7QUFDRDs7QUFDRCxZQUFNQyxLQUFLLEdBQUcsbUJBQW1CQyxJQUFuQixDQUF3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TixTQUFTLENBQUNoRCxJQUFWLENBQWVzRCxJQUFmLENBRFIsRUFFSkQsTUFGSSxDQUVHYyxPQUFPLElBQUlBLE9BQU8sSUFBSSxJQUZ6QixFQUdKWCxHQUhJLENBR0FXLE9BQU8sSUFBSUEsT0FBTyxDQUFFLENBQUYsQ0FIbEIsQ0FBUDtBQUlEOztBQUVNLFNBQVNDLE9BQVQsR0FBc0M7QUFDM0MsU0FBTyxJQUFJL0UsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0Q1UsZ0JBQUdpRCxPQUFILENBQVdjLE9BQVgsRUFBb0IsQ0FBQ3BFLEdBQUQsRUFBTXVELEtBQU4sS0FBZ0I7QUFDbEMsVUFBSXZELEdBQUosRUFBUztBQUNQbUUsUUFBQUEsSUFBSSxHQUFHLEVBQVA7QUFDQSxlQUFPeEUsTUFBTSxDQUFDSyxHQUFELENBQWI7QUFDRDs7QUFDRG1FLE1BQUFBLElBQUksR0FBR0csV0FBVyxDQUFDZixLQUFELENBQWxCO0FBQ0E3RCxNQUFBQSxPQUFPLENBQUN5RSxJQUFELENBQVA7QUFDRCxLQVBEO0FBUUQsR0FUTSxDQUFQO0FBVUQ7O0FBRU0sU0FBU00sV0FBVCxHQUFpQztBQUN0QyxNQUFJLENBQUNOLElBQUQsSUFBU0EsSUFBSSxDQUFDMUMsTUFBTCxLQUFnQixDQUE3QixFQUFnQztBQUM5QjBDLElBQUFBLElBQUksR0FBR0csV0FBVyxDQUFDakUsWUFBR3FFLFdBQUgsQ0FBZU4sT0FBZixDQUFELENBQWxCO0FBQ0Q7O0FBQ0QsU0FBT0QsSUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE9PTyBOYXRhLUluZm9cbiAqIEBhdXRob3IgQW5kcmVpIFNhcmFrZWV2IDxhdnNAbmF0YS1pbmZvLnJ1PlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBcIkBuYXRhXCIgcHJvamVjdC5cbiAqIEZvciB0aGUgZnVsbCBjb3B5cmlnaHQgYW5kIGxpY2Vuc2UgaW5mb3JtYXRpb24sIHBsZWFzZSB2aWV3XG4gKiB0aGUgRVVMQSBmaWxlIHRoYXQgd2FzIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyBzb3VyY2UgY29kZS5cbiAqL1xuXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgZGVjb2RlLCBlbmNvZGluZ0V4aXN0cyB9IGZyb20gJ2ljb252LWxpdGUnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzYXgsIHsgU0FYU3RyZWFtIH0gZnJvbSAnc2F4JztcbmltcG9ydCB7IFN0cmVhbSwgVHJhbnNmb3JtLCBUcmFuc2Zvcm1DYWxsYmFjayB9IGZyb20gJ3N0cmVhbSc7XG5cbnR5cGUgVGV4dEhhbmRsZXIgPSAodGhpczogU0FYU3RyZWFtLCB0ZXh0OiBzdHJpbmcpID0+IHZvaWQ7XG5cbmNsYXNzIFV0ZjhDb252ZXJ0ZXIgZXh0ZW5kcyBUcmFuc2Zvcm0ge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgZW5jb2Rpbmc6IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKCFlbmNvZGluZ0V4aXN0cyhlbmNvZGluZykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgZW5jb2RpbmcgJHtlbmNvZGluZ30gaXMgbm90IHN1cHBvcnRlZGApO1xuICAgIH1cbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICBwdWJsaWMgX3RyYW5zZm9ybShjaHVuazogYW55LCBfZW5jb2Rpbmc6IHN0cmluZywgY2FsbGJhY2s6IFRyYW5zZm9ybUNhbGxiYWNrKTogdm9pZCB7XG4gICAgY2FsbGJhY2sodW5kZWZpbmVkLCBkZWNvZGUoY2h1bmssIHRoaXMuZW5jb2RpbmcpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRFbmNvZGluZyhtaWJwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCBlbmNvZGluZzogc3RyaW5nO1xuICAgIGNvbnN0IHNheFN0cmVhbSA9IHNheC5jcmVhdGVTdHJlYW0odHJ1ZSwge30pO1xuICAgIHNheFN0cmVhbS5vbignZXJyb3InLCBlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgIHNheFN0cmVhbS5vbigncHJvY2Vzc2luZ2luc3RydWN0aW9uJywgKHBpKSA9PiB7XG4gICAgICBpZiAoIXBpLmJvZHkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgbWF0Y2ggPSAvZW5jb2Rpbmc9XCIoLiopXCIvZy5leGVjKHBpLmJvZHkpO1xuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIFssIGVuY29kaW5nXSA9IG1hdGNoO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHNheFN0cmVhbS5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShlbmNvZGluZykpO1xuICAgIGZzLmNyZWF0ZVJlYWRTdHJlYW0obWlicGF0aCkucGlwZShzYXhTdHJlYW0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1pYjJqc29uKG1pYnBhdGg6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBzYXhTdHJlYW0gPSBzYXguY3JlYXRlU3RyZWFtKFxuICAgICAgdHJ1ZSxcbiAgICAgIHtcbiAgICAgICAgeG1sbnM6IHRydWUsXG4gICAgICAgIHRyaW06IHRydWUsXG4gICAgICAgIG5vcm1hbGl6ZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgKTtcbiAgICBzYXhTdHJlYW0ub24oJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICBjb25zdCByb290OiBhbnkgPSB7fTtcbiAgICBsZXQgbGV2ZWwgPSAwO1xuICAgIGxldCBjdXJyZW50OiBhbnk7XG4gICAgY29uc3QgdHlwZXM6IGFueSA9IHt9O1xuICAgIGxldCBzdWJyb3V0aW5lczogYW55O1xuICAgIGNvbnN0IHRyYWlsOiBhbnlbXSA9IFtdO1xuICAgIGxldCBzdGF0ZTogc3RyaW5nO1xuICAgIHNheFN0cmVhbS5vbignb3BlbnRhZycsICh0YWcpID0+IHtcbi8vICAgICAgbG9nZ2VyLmVsZW1lbnQodXRpbC5pbnNwZWN0KHRhZywge2RlcHRoOiBudWxsfSkpO1xuICAgICAgaWYgKGxldmVsIDwgNSB8fCBzdWJyb3V0aW5lcykge1xuICAgICAgICBzd2l0Y2ggKHRhZy5sb2NhbCkge1xuICAgICAgICAgIGNhc2UgJ2VsZW1lbnQnOlxuICAgICAgICAgICAgaWYgKGxldmVsID09PSAxKSB7XG4gICAgICAgICAgICAgIHJvb3RbdGFnLmF0dHJpYnV0ZXMubmFtZS52YWx1ZV0gPSB0YWcuYXR0cmlidXRlcy50eXBlLnZhbHVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzdWJyb3V0aW5lcykge1xuICAgICAgICAgICAgICBjdXJyZW50ID0gc3Vicm91dGluZXNbdGFnLmF0dHJpYnV0ZXMubmFtZS52YWx1ZV0gPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3NpbXBsZVR5cGUnOlxuICAgICAgICAgIGNhc2UgJ2NvbXBsZXhUeXBlJzpcbiAgICAgICAgICAgIGlmIChsZXZlbCA9PT0gMSkge1xuICAgICAgICAgICAgICBjdXJyZW50ID0gdHlwZXNbdGFnLmF0dHJpYnV0ZXMubmFtZS52YWx1ZV0gPSB7fTtcbiAgICAgICAgICAgICAgdHJhaWwubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3NlcXVlbmNlJzpcbiAgICAgICAgICAgIGlmIChsZXZlbCA9PT0gMikge1xuICAgICAgICAgICAgICB0cmFpbC5wdXNoKGN1cnJlbnQpO1xuICAgICAgICAgICAgICBjdXJyZW50ID0gZmFsc2U7XG4gICAgICAgICAgICAgIHJvb3Quc3Vicm91dGluZXMgPSBzdWJyb3V0aW5lcyA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnYW5ub3RhdGlvbic6XG4gICAgICAgICAgICBzdGF0ZSA9ICdhbm5vdGF0aW9uJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2FwcGluZm8nOlxuICAgICAgICAgICAgY3VycmVudC5hcHBpbmZvID0ge307XG4gICAgICAgICAgICBzdGF0ZSA9ICdhcHBpbmZvJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3Jlc3RyaWN0aW9uJzpcbiAgICAgICAgICAgIGN1cnJlbnQuYmFzZSA9IHRhZy5hdHRyaWJ1dGVzLmJhc2UudmFsdWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdtaW5JbmNsdXNpdmUnOlxuICAgICAgICAgIGNhc2UgJ21heEluY2x1c2l2ZSc6XG4gICAgICAgICAgY2FzZSAnbWluRXhjbHVzaXZlJzpcbiAgICAgICAgICBjYXNlICdtYXhFeGNsdXNpdmUnOlxuICAgICAgICAgICAgY3VycmVudFt0YWcubG9jYWxdID0gdGFnLmF0dHJpYnV0ZXMudmFsdWUudmFsdWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdlbnVtZXJhdGlvbic6XG4gICAgICAgICAgICBjdXJyZW50LmVudW1lcmF0aW9uID0gY3VycmVudC5lbnVtZXJhdGlvbiB8fCB7fTtcbiAgICAgICAgICAgIHRyYWlsLnB1c2goY3VycmVudCk7XG4gICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5lbnVtZXJhdGlvblt0YWcuYXR0cmlidXRlcy52YWx1ZS52YWx1ZV0gPSB7fTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2F0dHJpYnV0ZSc6XG4gICAgICAgICAgICBjdXJyZW50LnByb3BlcnRpZXMgPSBjdXJyZW50LnByb3BlcnRpZXMgfHwge307XG4gICAgICAgICAgICB0cmFpbC5wdXNoKGN1cnJlbnQpO1xuICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucHJvcGVydGllc1t0YWcuYXR0cmlidXRlcy5uYW1lLnZhbHVlXSA9XG4gICAgICAgICAgICAgIHsgdHlwZTogdGFnLmF0dHJpYnV0ZXMudHlwZS52YWx1ZSB9O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGxldmVsICs9IDE7XG4gICAgfSk7XG5cbiAgICBzYXhTdHJlYW0ub24oJ2Nsb3NldGFnJywgKHRhZ05hbWUpID0+IHtcbiAgICAgIGxldmVsIC09IDE7XG5cbiAgICAgIGlmICh0YWdOYW1lID09PSAneHM6c2VxdWVuY2UnKSB7XG4gICAgICAgIHN1YnJvdXRpbmVzID0gZmFsc2U7XG4gICAgICAgIGN1cnJlbnQgPSB0cmFpbC5wb3AoKTtcbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudCkge1xuICAgICAgICBpZiAodGFnTmFtZSA9PT0gJ3hzOmF0dHJpYnV0ZScgfHwgdGFnTmFtZSA9PT0gJ3hzOmVudW1lcmF0aW9uJykge1xuICAgICAgICAgIGN1cnJlbnQgPSB0cmFpbC5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdGV4dEhhbmRsZXI6IFRleHRIYW5kbGVyID0gZnVuY3Rpb24gKHRleHQpIHtcbiAgICAgIGlmIChjdXJyZW50KSB7XG4gICAgICAgIGlmIChzdGF0ZSA9PT0gJ2FwcGluZm8nKSB7XG4gICAgICAgICAgY29uc3QgbG9jYWwgPSB0aGlzLl9wYXJzZXIudGFnLmxvY2FsO1xuICAgICAgICAgIGNvbnN0IGFwcGluZm8gPSBjdXJyZW50LmFwcGluZm87XG4gICAgICAgICAgaWYgKGFwcGluZm9bbG9jYWxdKSB7XG4gICAgICAgICAgICBhcHBpbmZvW2xvY2FsXSArPSBgXG4ke3RleHR9YDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXBwaW5mb1tsb2NhbF0gPSB0ZXh0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBzdGF0ZSA9PT0gJ2Fubm90YXRpb24nICYmIChjdXJyZW50LmFubm90YXRpb24gPSB0ZXh0KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc2F4U3RyZWFtLm9uKCd0ZXh0JywgdGV4dEhhbmRsZXIpO1xuXG4gICAgc2F4U3RyZWFtLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICByb290LnR5cGVzID0gdHlwZXM7XG4gICAgICByZXNvbHZlKHJvb3QpO1xuICAgIH0pO1xuXG4gICAgZ2V0RW5jb2RpbmcobWlicGF0aClcbiAgICAgIC50aGVuKChlbmNvZGluZykgPT4ge1xuICAgICAgICBsZXQgaW5wdXQ6IFN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0obWlicGF0aCk7XG4gICAgICAgIGlmIChlbmNvZGluZyAmJiBlbmNvZGluZ0V4aXN0cyhlbmNvZGluZykpIHtcbiAgICAgICAgICBpbnB1dCA9IGlucHV0LnBpcGUobmV3IFV0ZjhDb252ZXJ0ZXIoZW5jb2RpbmcpKTtcbiAgICAgICAgfVxuICAgICAgICBpbnB1dC5waXBlKHNheFN0cmVhbSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKHJlamVjdCk7XG4gIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29udmVydChtaWJwYXRoOiBzdHJpbmcsIGRpcj86IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IGpzb24gPSBhd2FpdCBtaWIyanNvbihtaWJwYXRoKTtcbiAgbGV0IGpzb25wYXRoID0gYCR7bWlicGF0aC5yZXBsYWNlKC9cXC5bXi8uXSskLywgJycpfS5qc29uYDtcbiAgaWYgKGRpcikge1xuICAgIGpzb25wYXRoID0gcGF0aC5yZXNvbHZlKGRpciwgcGF0aC5iYXNlbmFtZShqc29ucGF0aCkpO1xuICB9XG4gIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShqc29uLCBudWxsLCAyKTtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGZzLndyaXRlRmlsZShqc29ucGF0aCwgZGF0YSwgKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoanNvbnBhdGgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuY29uc3QgeHNkTWliUmUgPSAvXlxcUytcXC5taWJcXC54c2QkL2k7XG5jb25zdCBqc29uTWliUmUgPSAvXihcXFMrKVxcLm1pYlxcLmpzb24kL2k7XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0RGlyKGRpcjogc3RyaW5nKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZnMucmVhZGRpcihkaXIsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHByb21pc2VzOiBQcm9taXNlPHZvaWQ+W10gPSBmaWxlc1xuICAgICAgICAuZmlsdGVyKGZpbGUgPT4geHNkTWliUmUudGVzdChmaWxlKSlcbiAgICAgICAgLm1hcChmaWxlID0+IGNvbnZlcnQocGF0aC5qb2luKGRpciwgZmlsZSkpXG4gICAgICAgICAgLnRoZW4oKCkgPT4gY29uc29sZS5pbmZvKGAke2ZpbGV9OiBzdWNjZXNzYCkpXG4gICAgICAgICAgLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoYCR7ZmlsZX06ICR7ZXJyb3IubWVzc2FnZX1gKSksXG4gICAgICAgICk7XG4gICAgICByZXNvbHZlKFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHZvaWQgMCkpO1xuICAgIH0pO1xuICB9KTtcbn1cblxubGV0IG1pYnM6IHN0cmluZ1tdID0gW107XG5jb25zdCBtaWJzRGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uL21pYnMnKTtcblxuZnVuY3Rpb24gZmlsZXNUb01pYnMoZmlsZXM6IHN0cmluZ1tdKSB7XG4gIHJldHVybiBmaWxlc1xuICAgIC5tYXAoZmlsZSA9PiBqc29uTWliUmUuZXhlYyhmaWxlKSlcbiAgICAuZmlsdGVyKG1hdGNoZXMgPT4gbWF0Y2hlcyAhPSBudWxsKVxuICAgIC5tYXAobWF0Y2hlcyA9PiBtYXRjaGVzIVsxXSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNaWJzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBmcy5yZWFkZGlyKG1pYnNEaXIsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIG1pYnMgPSBbXTtcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgfVxuICAgICAgbWlicyA9IGZpbGVzVG9NaWJzKGZpbGVzKTtcbiAgICAgIHJlc29sdmUobWlicyk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWlic1N5bmMoKTogc3RyaW5nW10ge1xuICBpZiAoIW1pYnMgfHwgbWlicy5sZW5ndGggPT09IDApIHtcbiAgICBtaWJzID0gZmlsZXNUb01pYnMoZnMucmVhZGRpclN5bmMobWlic0RpcikpO1xuICB9XG4gIHJldHVybiBtaWJzO1xufVxuIl19