"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.mib2json = mib2json;
exports.convert = convert;
exports.convertDir = convertDir;
exports.getMibs = getMibs;
exports.getMibsSync = getMibsSync;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _iconvLite = require("iconv-lite");

var path = _interopRequireWildcard(require("path"));

var _sax = _interopRequireDefault(require("sax"));

var _stream = require("stream");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
class Utf8Converter extends _stream.Transform {
  constructor(encoding) {
    super();
    this.encoding = encoding;

    if (!(0, _iconvLite.encodingExists)(encoding)) {
      throw new Error(`encoding ${encoding} is not supported`);
    }
  } // tslint:disable-next-line


  _transform(chunk, _encoding, callback) {
    callback(undefined, (0, _iconvLite.decode)(chunk, this.encoding));
  }

}

function getEncoding(mibpath) {
  return new Promise((resolve, reject) => {
    let encoding;

    const saxStream = _sax.default.createStream(true, {});

    saxStream.on('error', err => reject(err));
    saxStream.on('processinginstruction', pi => {
      if (!pi.body) {
        return;
      }

      const match = /encoding="(.*)"/g.exec(pi.body);

      if (match) {
        [, encoding] = match;
      }
    });
    saxStream.on('end', () => resolve(encoding));

    _fs.default.createReadStream(mibpath).pipe(saxStream);
  });
}

function mib2json(mibpath) {
  return new Promise((resolve, reject) => {
    const saxStream = _sax.default.createStream(true, {
      xmlns: true,
      trim: true,
      normalize: true
    });

    saxStream.on('error', err => reject(err));
    const root = {};
    let level = 0;
    let current;
    const types = {};
    let subroutines;
    const trail = [];
    let state;
    saxStream.on('opentag', tag => {
      //      logger.element(util.inspect(tag, {depth: null}));
      if (level < 5 || subroutines) {
        switch (tag.local) {
          case 'element':
            if (level === 1) {
              root[tag.attributes.name.value] = tag.attributes.type.value;
            } else if (subroutines) {
              current = subroutines[tag.attributes.name.value] = {};
            }

            break;

          case 'simpleType':
          case 'complexType':
            if (level === 1) {
              current = types[tag.attributes.name.value] = {};
              trail.length = 0;
            }

            break;

          case 'sequence':
            if (level === 2) {
              trail.push(current);
              current = false;
              root.subroutines = subroutines = {};
            }

            break;

          case 'annotation':
            state = 'annotation';
            break;

          case 'appinfo':
            current.appinfo = {};
            state = 'appinfo';
            break;

          case 'restriction':
            current.base = tag.attributes.base.value;
            break;

          case 'minInclusive':
          case 'maxInclusive':
          case 'minExclusive':
          case 'maxExclusive':
            current[tag.local] = tag.attributes.value.value;
            break;

          case 'enumeration':
            current.enumeration = current.enumeration || {};
            trail.push(current);
            current = current.enumeration[tag.attributes.value.value] = {};
            break;

          case 'attribute':
            current.properties = current.properties || {};
            trail.push(current);
            current = current.properties[tag.attributes.name.value] = {
              type: tag.attributes.type.value
            };
            break;
        }
      }

      level += 1;
    });
    saxStream.on('closetag', tagName => {
      level -= 1;

      if (tagName === 'xs:sequence') {
        subroutines = false;
        current = trail.pop();
      } else if (current) {
        if (tagName === 'xs:attribute' || tagName === 'xs:enumeration') {
          current = trail.pop();
        }
      }
    });

    const textHandler = function (text) {
      if (current) {
        if (state === 'appinfo') {
          const local = this._parser.tag.local;
          const appinfo = current.appinfo;

          if (appinfo[local]) {
            appinfo[local] += `
${text}`;
          } else {
            appinfo[local] = text;
          }
        }

        state === 'annotation' && (current.annotation = text);
      }
    };

    saxStream.on('text', textHandler);
    saxStream.on('end', () => {
      root.types = types;
      resolve(root);
    });
    getEncoding(mibpath).then(encoding => {
      let input = _fs.default.createReadStream(mibpath);

      if (encoding && (0, _iconvLite.encodingExists)(encoding)) {
        input = input.pipe(new Utf8Converter(encoding));
      }

      input.pipe(saxStream);
    }).catch(reject);
  });
}

async function convert(mibpath, dir) {
  const json = await mib2json(mibpath);
  let jsonpath = `${mibpath.replace(/\.[^/.]+$/, '')}.json`;

  if (dir) {
    jsonpath = path.resolve(dir, path.basename(jsonpath));
  }

  const data = JSON.stringify(json, null, 2);
  return new Promise((resolve, reject) => {
    _fs.default.writeFile(jsonpath, data, err => {
      if (err) {
        reject(err);
      } else {
        resolve(jsonpath);
      }
    });
  });
}

const xsdMibRe = /^\S+\.mib\.xsd$/i;
const jsonMibRe = /^(\S+)\.mib\.json$/i;

function convertDir(dir) {
  return new Promise((resolve, reject) => {
    _fs.default.readdir(dir, (err, files) => {
      if (err) {
        return reject(err);
      }

      const promises = files.filter(file => xsdMibRe.test(file)).map(file => convert(path.join(dir, file)).then(() => console.info(`${file}: success`)).catch(error => console.error(`${file}: ${error.message}`)));
      resolve(Promise.all(promises).then(() => void 0));
    });
  });
}

let mibs = [];
const mibsDir = path.resolve(__dirname, '../../mibs');

function filesToMibs(files) {
  return files.map(file => jsonMibRe.exec(file)).filter(matches => matches != null).map(matches => matches[1]);
}

function getMibs() {
  return new Promise((resolve, reject) => {
    _fs.default.readdir(mibsDir, (err, files) => {
      if (err) {
        mibs = [];
        return reject(err);
      }

      mibs = filesToMibs(files);
      resolve(mibs);
    });
  });
}

function getMibsSync() {
  if (!mibs || mibs.length === 0) {
    mibs = filesToMibs(_fs.default.readdirSync(mibsDir));
  }

  return mibs;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWIvbWliMmpzb24udHMiXSwibmFtZXMiOlsiVXRmOENvbnZlcnRlciIsIlRyYW5zZm9ybSIsImNvbnN0cnVjdG9yIiwiZW5jb2RpbmciLCJFcnJvciIsIl90cmFuc2Zvcm0iLCJjaHVuayIsIl9lbmNvZGluZyIsImNhbGxiYWNrIiwidW5kZWZpbmVkIiwiZ2V0RW5jb2RpbmciLCJtaWJwYXRoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzYXhTdHJlYW0iLCJzYXgiLCJjcmVhdGVTdHJlYW0iLCJvbiIsImVyciIsInBpIiwiYm9keSIsIm1hdGNoIiwiZXhlYyIsImZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBpcGUiLCJtaWIyanNvbiIsInhtbG5zIiwidHJpbSIsIm5vcm1hbGl6ZSIsInJvb3QiLCJsZXZlbCIsImN1cnJlbnQiLCJ0eXBlcyIsInN1YnJvdXRpbmVzIiwidHJhaWwiLCJzdGF0ZSIsInRhZyIsImxvY2FsIiwiYXR0cmlidXRlcyIsIm5hbWUiLCJ2YWx1ZSIsInR5cGUiLCJsZW5ndGgiLCJwdXNoIiwiYXBwaW5mbyIsImJhc2UiLCJlbnVtZXJhdGlvbiIsInByb3BlcnRpZXMiLCJ0YWdOYW1lIiwicG9wIiwidGV4dEhhbmRsZXIiLCJ0ZXh0IiwiX3BhcnNlciIsImFubm90YXRpb24iLCJ0aGVuIiwiaW5wdXQiLCJjYXRjaCIsImNvbnZlcnQiLCJkaXIiLCJqc29uIiwianNvbnBhdGgiLCJyZXBsYWNlIiwicGF0aCIsImJhc2VuYW1lIiwiZGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ3cml0ZUZpbGUiLCJ4c2RNaWJSZSIsImpzb25NaWJSZSIsImNvbnZlcnREaXIiLCJyZWFkZGlyIiwiZmlsZXMiLCJwcm9taXNlcyIsImZpbHRlciIsImZpbGUiLCJ0ZXN0IiwibWFwIiwiam9pbiIsImNvbnNvbGUiLCJpbmZvIiwiZXJyb3IiLCJtZXNzYWdlIiwiYWxsIiwibWlicyIsIm1pYnNEaXIiLCJfX2Rpcm5hbWUiLCJm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SUFBZixDQURSLEVBRUpELE1BRkksQ0FFR2MsT0FBTyxJQUFJQSxPQUFPLElBQUksSUFGekIsRUFHSlgsR0FISSxDQUdBVyxPQUFPLElBQUlBLE9BQU8sQ0FBRSxDQUFGLENBSGxCLENBQVA7QUFJRDs7QUFFTSxTQUFTQyxPQUFULEdBQXNDO0FBQzNDLFNBQU8sSUFBSS9FLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdENVLGdCQUFHaUQsT0FBSCxDQUFXYyxPQUFYLEVBQW9CLENBQUNwRSxHQUFELEVBQU11RCxLQUFOLEtBQWdCO0FBQ2xDLFVBQUl2RCxHQUFKLEVBQVM7QUFDUG1FLFFBQUFBLElBQUksR0FBRyxFQUFQO0FBQ0EsZUFBT3hFLE1BQU0sQ0FBQ0ssR0FBRCxDQUFiO0FBQ0Q7O0FBQ0RtRSxNQUFBQSxJQUFJLEdBQUdHLFdBQVcsQ0FBQ2YsS0FBRCxDQUFsQjtBQUNBN0QsTUFBQUEsT0FBTyxDQUFDeUUsSUFBRCxDQUFQO0FBQ0QsS0FQRDtBQVFELEdBVE0sQ0FBUDtBQVVEOztBQUVNLFNBQVNNLFdBQVQsR0FBaUM7QUFDdEMsTUFBSSxDQUFDTixJQUFELElBQVNBLElBQUksQ0FBQzFDLE1BQUwsS0FBZ0IsQ0FBN0IsRUFBZ0M7QUFDOUIwQyxJQUFBQSxJQUFJLEdBQUdHLFdBQVcsQ0FBQ2pFLFlBQUdxRSxXQUFILENBQWVOLE9BQWYsQ0FBRCxDQUFsQjtBQUNEOztBQUNELFNBQU9ELElBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBPT08gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IGRlY29kZSwgZW5jb2RpbmdFeGlzdHMgfSBmcm9tICdpY29udi1saXRlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2F4LCB7IFNBWFN0cmVhbSB9IGZyb20gJ3NheCc7XG5pbXBvcnQgeyBTdHJlYW0sIFRyYW5zZm9ybSwgVHJhbnNmb3JtQ2FsbGJhY2sgfSBmcm9tICdzdHJlYW0nO1xuXG50eXBlIFRleHRIYW5kbGVyID0gKHRoaXM6IFNBWFN0cmVhbSwgdGV4dDogc3RyaW5nKSA9PiB2b2lkO1xuXG5jbGFzcyBVdGY4Q29udmVydGVyIGV4dGVuZHMgVHJhbnNmb3JtIHtcbiAgY29uc3RydWN0b3IocHVibGljIGVuY29kaW5nOiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghZW5jb2RpbmdFeGlzdHMoZW5jb2RpbmcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGVuY29kaW5nICR7ZW5jb2Rpbmd9IGlzIG5vdCBzdXBwb3J0ZWRgKTtcbiAgICB9XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgcHVibGljIF90cmFuc2Zvcm0oY2h1bms6IGFueSwgX2VuY29kaW5nOiBzdHJpbmcsIGNhbGxiYWNrOiBUcmFuc2Zvcm1DYWxsYmFjayk6IHZvaWQge1xuICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgZGVjb2RlKGNodW5rLCB0aGlzLmVuY29kaW5nKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RW5jb2RpbmcobWlicGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBsZXQgZW5jb2Rpbmc6IHN0cmluZztcbiAgICBjb25zdCBzYXhTdHJlYW0gPSBzYXguY3JlYXRlU3RyZWFtKHRydWUsIHt9KTtcbiAgICBzYXhTdHJlYW0ub24oJ2Vycm9yJywgZXJyID0+IHJlamVjdChlcnIpKTtcbiAgICBzYXhTdHJlYW0ub24oJ3Byb2Nlc3NpbmdpbnN0cnVjdGlvbicsIChwaSkgPT4ge1xuICAgICAgaWYgKCFwaS5ib2R5KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1hdGNoID0gL2VuY29kaW5nPVwiKC4qKVwiL2cuZXhlYyhwaS5ib2R5KTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBbLCBlbmNvZGluZ10gPSBtYXRjaDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBzYXhTdHJlYW0ub24oJ2VuZCcsICgpID0+IHJlc29sdmUoZW5jb2RpbmcpKTtcbiAgICBmcy5jcmVhdGVSZWFkU3RyZWFtKG1pYnBhdGgpLnBpcGUoc2F4U3RyZWFtKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtaWIyanNvbihtaWJwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3Qgc2F4U3RyZWFtID0gc2F4LmNyZWF0ZVN0cmVhbShcbiAgICAgIHRydWUsXG4gICAgICB7XG4gICAgICAgIHhtbG5zOiB0cnVlLFxuICAgICAgICB0cmltOiB0cnVlLFxuICAgICAgICBub3JtYWxpemU6IHRydWUsXG4gICAgICB9LFxuICAgICk7XG4gICAgc2F4U3RyZWFtLm9uKCdlcnJvcicsIGVyciA9PiByZWplY3QoZXJyKSk7XG4gICAgY29uc3Qgcm9vdDogYW55ID0ge307XG4gICAgbGV0IGxldmVsID0gMDtcbiAgICBsZXQgY3VycmVudDogYW55O1xuICAgIGNvbnN0IHR5cGVzOiBhbnkgPSB7fTtcbiAgICBsZXQgc3Vicm91dGluZXM6IGFueTtcbiAgICBjb25zdCB0cmFpbDogYW55W10gPSBbXTtcbiAgICBsZXQgc3RhdGU6IHN0cmluZztcbiAgICBzYXhTdHJlYW0ub24oJ29wZW50YWcnLCAodGFnKSA9PiB7XG4vLyAgICAgIGxvZ2dlci5lbGVtZW50KHV0aWwuaW5zcGVjdCh0YWcsIHtkZXB0aDogbnVsbH0pKTtcbiAgICAgIGlmIChsZXZlbCA8IDUgfHwgc3Vicm91dGluZXMpIHtcbiAgICAgICAgc3dpdGNoICh0YWcubG9jYWwpIHtcbiAgICAgICAgICBjYXNlICdlbGVtZW50JzpcbiAgICAgICAgICAgIGlmIChsZXZlbCA9PT0gMSkge1xuICAgICAgICAgICAgICByb290W3RhZy5hdHRyaWJ1dGVzLm5hbWUudmFsdWVdID0gdGFnLmF0dHJpYnV0ZXMudHlwZS52YWx1ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3Vicm91dGluZXMpIHtcbiAgICAgICAgICAgICAgY3VycmVudCA9IHN1YnJvdXRpbmVzW3RhZy5hdHRyaWJ1dGVzLm5hbWUudmFsdWVdID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdzaW1wbGVUeXBlJzpcbiAgICAgICAgICBjYXNlICdjb21wbGV4VHlwZSc6XG4gICAgICAgICAgICBpZiAobGV2ZWwgPT09IDEpIHtcbiAgICAgICAgICAgICAgY3VycmVudCA9IHR5cGVzW3RhZy5hdHRyaWJ1dGVzLm5hbWUudmFsdWVdID0ge307XG4gICAgICAgICAgICAgIHRyYWlsLmxlbmd0aCA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdzZXF1ZW5jZSc6XG4gICAgICAgICAgICBpZiAobGV2ZWwgPT09IDIpIHtcbiAgICAgICAgICAgICAgdHJhaWwucHVzaChjdXJyZW50KTtcbiAgICAgICAgICAgICAgY3VycmVudCA9IGZhbHNlO1xuICAgICAgICAgICAgICByb290LnN1YnJvdXRpbmVzID0gc3Vicm91dGluZXMgPSB7fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2Fubm90YXRpb24nOlxuICAgICAgICAgICAgc3RhdGUgPSAnYW5ub3RhdGlvbic7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdhcHBpbmZvJzpcbiAgICAgICAgICAgIGN1cnJlbnQuYXBwaW5mbyA9IHt9O1xuICAgICAgICAgICAgc3RhdGUgPSAnYXBwaW5mbyc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdyZXN0cmljdGlvbic6XG4gICAgICAgICAgICBjdXJyZW50LmJhc2UgPSB0YWcuYXR0cmlidXRlcy5iYXNlLnZhbHVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnbWluSW5jbHVzaXZlJzpcbiAgICAgICAgICBjYXNlICdtYXhJbmNsdXNpdmUnOlxuICAgICAgICAgIGNhc2UgJ21pbkV4Y2x1c2l2ZSc6XG4gICAgICAgICAgY2FzZSAnbWF4RXhjbHVzaXZlJzpcbiAgICAgICAgICAgIGN1cnJlbnRbdGFnLmxvY2FsXSA9IHRhZy5hdHRyaWJ1dGVzLnZhbHVlLnZhbHVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnZW51bWVyYXRpb24nOlxuICAgICAgICAgICAgY3VycmVudC5lbnVtZXJhdGlvbiA9IGN1cnJlbnQuZW51bWVyYXRpb24gfHwge307XG4gICAgICAgICAgICB0cmFpbC5wdXNoKGN1cnJlbnQpO1xuICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuZW51bWVyYXRpb25bdGFnLmF0dHJpYnV0ZXMudmFsdWUudmFsdWVdID0ge307XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdhdHRyaWJ1dGUnOlxuICAgICAgICAgICAgY3VycmVudC5wcm9wZXJ0aWVzID0gY3VycmVudC5wcm9wZXJ0aWVzIHx8IHt9O1xuICAgICAgICAgICAgdHJhaWwucHVzaChjdXJyZW50KTtcbiAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnByb3BlcnRpZXNbdGFnLmF0dHJpYnV0ZXMubmFtZS52YWx1ZV0gPVxuICAgICAgICAgICAgICB7IHR5cGU6IHRhZy5hdHRyaWJ1dGVzLnR5cGUudmFsdWUgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXZlbCArPSAxO1xuICAgIH0pO1xuXG4gICAgc2F4U3RyZWFtLm9uKCdjbG9zZXRhZycsICh0YWdOYW1lKSA9PiB7XG4gICAgICBsZXZlbCAtPSAxO1xuXG4gICAgICBpZiAodGFnTmFtZSA9PT0gJ3hzOnNlcXVlbmNlJykge1xuICAgICAgICBzdWJyb3V0aW5lcyA9IGZhbHNlO1xuICAgICAgICBjdXJyZW50ID0gdHJhaWwucG9wKCk7XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnQpIHtcbiAgICAgICAgaWYgKHRhZ05hbWUgPT09ICd4czphdHRyaWJ1dGUnIHx8IHRhZ05hbWUgPT09ICd4czplbnVtZXJhdGlvbicpIHtcbiAgICAgICAgICBjdXJyZW50ID0gdHJhaWwucG9wKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHRleHRIYW5kbGVyOiBUZXh0SGFuZGxlciA9IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgICBpZiAoY3VycmVudCkge1xuICAgICAgICBpZiAoc3RhdGUgPT09ICdhcHBpbmZvJykge1xuICAgICAgICAgIGNvbnN0IGxvY2FsID0gdGhpcy5fcGFyc2VyLnRhZy5sb2NhbDtcbiAgICAgICAgICBjb25zdCBhcHBpbmZvID0gY3VycmVudC5hcHBpbmZvO1xuICAgICAgICAgIGlmIChhcHBpbmZvW2xvY2FsXSkge1xuICAgICAgICAgICAgYXBwaW5mb1tsb2NhbF0gKz0gYFxuJHt0ZXh0fWA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFwcGluZm9bbG9jYWxdID0gdGV4dDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUgPT09ICdhbm5vdGF0aW9uJyAmJiAoY3VycmVudC5hbm5vdGF0aW9uID0gdGV4dCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHNheFN0cmVhbS5vbigndGV4dCcsIHRleHRIYW5kbGVyKTtcblxuICAgIHNheFN0cmVhbS5vbignZW5kJywgKCkgPT4ge1xuICAgICAgcm9vdC50eXBlcyA9IHR5cGVzO1xuICAgICAgcmVzb2x2ZShyb290KTtcbiAgICB9KTtcblxuICAgIGdldEVuY29kaW5nKG1pYnBhdGgpXG4gICAgICAudGhlbigoZW5jb2RpbmcpID0+IHtcbiAgICAgICAgbGV0IGlucHV0OiBTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKG1pYnBhdGgpO1xuICAgICAgICBpZiAoZW5jb2RpbmcgJiYgZW5jb2RpbmdFeGlzdHMoZW5jb2RpbmcpKSB7XG4gICAgICAgICAgaW5wdXQgPSBpbnB1dC5waXBlKG5ldyBVdGY4Q29udmVydGVyKGVuY29kaW5nKSk7XG4gICAgICAgIH1cbiAgICAgICAgaW5wdXQucGlwZShzYXhTdHJlYW0pO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChyZWplY3QpO1xuICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnZlcnQobWlicGF0aDogc3RyaW5nLCBkaXI/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBqc29uID0gYXdhaXQgbWliMmpzb24obWlicGF0aCk7XG4gIGxldCBqc29ucGF0aCA9IGAke21pYnBhdGgucmVwbGFjZSgvXFwuW14vLl0rJC8sICcnKX0uanNvbmA7XG4gIGlmIChkaXIpIHtcbiAgICBqc29ucGF0aCA9IHBhdGgucmVzb2x2ZShkaXIsIHBhdGguYmFzZW5hbWUoanNvbnBhdGgpKTtcbiAgfVxuICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkoanNvbiwgbnVsbCwgMik7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBmcy53cml0ZUZpbGUoanNvbnBhdGgsIGRhdGEsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKGpzb25wYXRoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmNvbnN0IHhzZE1pYlJlID0gL15cXFMrXFwubWliXFwueHNkJC9pO1xuY29uc3QganNvbk1pYlJlID0gL14oXFxTKylcXC5taWJcXC5qc29uJC9pO1xuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydERpcihkaXI6IHN0cmluZykge1xuICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGZzLnJlYWRkaXIoZGlyLCAoZXJyLCBmaWxlcykgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgICBjb25zdCBwcm9taXNlczogUHJvbWlzZTx2b2lkPltdID0gZmlsZXNcbiAgICAgICAgLmZpbHRlcihmaWxlID0+IHhzZE1pYlJlLnRlc3QoZmlsZSkpXG4gICAgICAgIC5tYXAoZmlsZSA9PiBjb252ZXJ0KHBhdGguam9pbihkaXIsIGZpbGUpKVxuICAgICAgICAgIC50aGVuKCgpID0+IGNvbnNvbGUuaW5mbyhgJHtmaWxlfTogc3VjY2Vzc2ApKVxuICAgICAgICAgIC5jYXRjaChlcnJvciA9PiBjb25zb2xlLmVycm9yKGAke2ZpbGV9OiAke2Vycm9yLm1lc3NhZ2V9YCkpLFxuICAgICAgICApO1xuICAgICAgcmVzb2x2ZShQcm9taXNlLmFsbChwcm9taXNlcykudGhlbigoKSA9PiB2b2lkIDApKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmxldCBtaWJzOiBzdHJpbmdbXSA9IFtdO1xuY29uc3QgbWlic0RpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi9taWJzJyk7XG5cbmZ1bmN0aW9uIGZpbGVzVG9NaWJzKGZpbGVzOiBzdHJpbmdbXSkge1xuICByZXR1cm4gZmlsZXNcbiAgICAubWFwKGZpbGUgPT4ganNvbk1pYlJlLmV4ZWMoZmlsZSkpXG4gICAgLmZpbHRlcihtYXRjaGVzID0+IG1hdGNoZXMgIT0gbnVsbClcbiAgICAubWFwKG1hdGNoZXMgPT4gbWF0Y2hlcyFbMV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWlicygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZnMucmVhZGRpcihtaWJzRGlyLCAoZXJyLCBmaWxlcykgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBtaWJzID0gW107XG4gICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIG1pYnMgPSBmaWxlc1RvTWlicyhmaWxlcyk7XG4gICAgICByZXNvbHZlKG1pYnMpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1pYnNTeW5jKCk6IHN0cmluZ1tdIHtcbiAgaWYgKCFtaWJzIHx8IG1pYnMubGVuZ3RoID09PSAwKSB7XG4gICAgbWlicyA9IGZpbGVzVG9NaWJzKGZzLnJlYWRkaXJTeW5jKG1pYnNEaXIpKTtcbiAgfVxuICByZXR1cm4gbWlicztcbn1cbiJdfQ==